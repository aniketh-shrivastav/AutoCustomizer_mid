<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order & Booking History</title>
    <link rel="stylesheet" href="/styles/styles.css" />
  </head>
  <body>
    <header>
      <div class="logo">
        <img src="/images3/logo2.jpg" alt="AutoCustomizer Logo" />
      </div>
      <nav>
        <ul class="nav-links">
          <li><a href="/">Home</a></li>
          <li><a href="/customer/index.html">Products</a></li>
          <li><a href="/customer/booking.html">Services</a></li>
          <li>
            <a href="/customer/history.html" class="active">Order History</a>
          </li>
          <li>
            <a href="/customer/cart.html" class="cart-link"
              ><img src="/images/cart-icon.png" alt="Cart" />
              <span>Cart</span></a
            >
          </li>
          <li><a href="/customer/profile.html">Profile</a></li>
          <li><a href="/logout">Logout</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <h2>Upcoming Orders</h2>
      <ul id="upcoming-orders" class="parts-list">
        <p class="loading">Loading...</p>
      </ul>

      <h2>Past Orders</h2>
      <ul id="past-orders" class="parts-list">
        <p class="loading">Loading...</p>
      </ul>

      <h2>Upcoming Services</h2>
      <ul id="upcoming-services" class="parts-list">
        <p class="loading">Loading...</p>
      </ul>

      <h2>Past Services</h2>
      <ul id="past-services" class="parts-list">
        <p class="loading">Loading...</p>
      </ul>
    </main>

    <footer>
      <div class="footer-container">
        <div class="footer-section">
          <h3>Contact Us</h3>
          <p>Email: support@autocustomizer.com</p>
          <p>Phone: +123-456-7890</p>
          <p>Address: 123 Auto Street, Custom City</p>
        </div>
        <div class="footer-section">
          <h3>Follow Us</h3>
          <div class="social-icons">
            <a href="#"
              ><img src="/images/facebook-icon.png" alt="Facebook"
            /></a>
            <a href="#"><img src="/images/twitter-icon.png" alt="Twitter" /></a>
            <a href="#"
              ><img src="/images/instagram-icon.png" alt="Instagram"
            /></a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 AutoCustomizer. All Rights Reserved.</p>
      </div>
    </footer>

    <!-- Rating Modal -->
    <div id="ratingModal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close" id="closeRatingModal">&times;</span>
        <h3>Rate This Service</h3>
        <form id="ratingForm">
          <input type="hidden" name="bookingId" id="bookingId" />
          <label for="rating">Rating (1 to 5):</label>
          <input
            type="number"
            name="rating"
            id="rating"
            min="1"
            max="5"
            required
          /><br /><br />
          <label for="review">Comment (optional):</label><br />
          <textarea name="review" id="review" rows="4" cols="40"></textarea
          ><br /><br />
          <button type="submit" class="rate-btn">Submit Rating</button>
        </form>
      </div>
    </div>

    <style>
      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 20px;
        margin-bottom: 15px;
        transition: var(--transition);
      }
      .item-details {
        flex: 1;
      }
      .item-details h3 {
        font-size: 18px;
        margin-bottom: 8px;
        color: var(--text-dark);
      }
      .item-details p {
        color: #666;
        font-size: 14px;
      }
      .rate-btn,
      .cancel-btn,
      .download-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 6px;
        display: inline-block;
        text-decoration: none;
      }
      .rate-btn {
        background: var(--warning-color);
      }
      .download-btn {
        background: var(--warning-color);
        color: #fff;
        text-decoration: none;
        line-height: 1.2;
      }
      .download-btn:hover {
        filter: brightness(0.95);
        text-decoration: none;
      }
      .cancel-btn {
        background: #c0392b;
      }
      .rate-btn:hover,
      .cancel-btn:hover,
      .download-btn:hover {
        opacity: 0.9;
      }
      .no-items {
        text-align: center;
        color: #888;
        padding: 20px;
        font-style: italic;
      }
      .modal {
        position: fixed;
        z-index: 999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
        box-shadow: 0 0 10px #000;
      }
      .close {
        float: right;
        font-size: 24px;
        cursor: pointer;
      }
      @media screen and (max-width: 768px) {
        .history-item {
          flex-direction: column;
          text-align: center;
        }
        .item-details {
          margin-bottom: 15px;
        }
      }
    </style>

    <script>
      async function fetchHistory() {
        try {
          const res = await fetch("/customer/api/history", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          if (!res.ok) throw new Error("Failed to load history");
          const data = await res.json();
          renderOrders(data.upcomingOrders || [], data.pastOrders || []);
          renderServices(data.bookings || []);
        } catch (err) {
          console.error("History load error:", err);
          document
            .querySelectorAll(".parts-list")
            .forEach(
              (ul) =>
                (ul.innerHTML =
                  '<p class="no-items">Failed to load. Refresh page.</p>')
            );
        }
      }

      function renderOrders(upcoming, past) {
        const upEl = document.getElementById("upcoming-orders");
        const pastEl = document.getElementById("past-orders");

        // Upcoming Orders
        if (!upcoming.length) {
          upEl.innerHTML = '<p class="no-items">No upcoming orders found.</p>';
        } else {
          upEl.innerHTML = upcoming
            .map(
              (o) => `
          <li class="history-item">
            <div class="item-details">
              <h3>Order ID: ${o._id}</h3>
              <p><strong>Placed on:</strong> ${formatDate(o.placedAt)}</p>
              <p><strong>Status:</strong> ${statusSpan(o.orderStatus)}</p>
              <p><strong>Total Amount:</strong> ₹${o.totalAmount}</p>
              <p><strong>Items:</strong></p>
              <ul>${(o.items || [])
                .map((i) => `<li>${i.name} x ${i.quantity} (₹${i.price})</li>`)
                .join("")}</ul>
              ${
                o.orderStatus === "pending"
                  ? `<button class="cancel-btn" onclick="cancelOrder('${o._id}')">Cancel Order</button>`
                  : ""
              }
            </div>
          </li>`
            )
            .join("");
        }

        // Past Orders
        if (!past.length) {
          pastEl.innerHTML = '<p class="no-items">No past orders found.</p>';
        } else {
          pastEl.innerHTML = past
            .map(
              (o) => `
          <li class="history-item">
            <div class="item-details">
              <h3>Order ID: ${o._id}</h3>
              <p><strong>Placed on:</strong> ${formatDate(o.placedAt)}</p>
              <p><strong>Status:</strong> ${o.orderStatus}</p>
              <p><strong>Total Amount:</strong> ₹${o.totalAmount}</p>
              <p><strong>Items:</strong></p>
              <ul>${(o.items || [])
                .map((i) => `<li>${i.name} x ${i.quantity} (₹${i.price})</li>`)
                .join("")}</ul>
              ${
                !(o.orderStatus || "").toLowerCase().includes("cancel")
                  ? `<a href="/customer/order-receipt/${o._id}" target="_blank" class="download-btn">Download Receipt</a>`
                  : ""
              }
            </div>
          </li>`
            )
            .join("");
        }
      }

      function renderServices(bookings) {
        const upcomingEl = document.getElementById("upcoming-services");
        const pastEl = document.getElementById("past-services");

        const upcoming = bookings.filter((b) =>
          ["Open", "Confirmed"].includes(b.status)
        );
        const past = bookings.filter((b) =>
          ["Ready", "Rejected"].includes(b.status)
        );

        // Upcoming Services
        if (!upcoming.length) {
          upcomingEl.innerHTML =
            '<p class="no-items">No upcoming services found.</p>';
        } else {
          upcomingEl.innerHTML = upcoming
            .map(
              (s) => `
          <li class="history-item">
            <div class="item-details">
              <h3>${(s.selectedServices || []).join(", ")}</h3>
              <p><strong>Service ID:</strong> ${s._id}</p>
              <p><strong>Service Provider:</strong> ${
                s.providerId?.name || ""
              } | ${s.providerId?.phone || ""}</p>
              <p><strong>Booked on:</strong> ${formatDate(s.createdAt)}</p>
              <p><strong>Car Model:</strong> ${s.carModel || ""}</p>
              <p><strong>Description:</strong> ${s.description || ""}</p>
              <p><strong>Cost:</strong> ₹${s.totalCost || 0}</p>
              <p><strong>Status:</strong> ${serviceStatusSpan(
                s.status,
                s._id
              )}</p>
            </div>
          </li>`
            )
            .join("");
        }

        // Past Services
        if (!past.length) {
          pastEl.innerHTML = '<p class="no-items">No past services found.</p>';
        } else {
          pastEl.innerHTML = past
            .map(
              (s) => `
          <li class="history-item">
            <div class="item-details">
              <h3>${(s.selectedServices || []).join(", ")}</h3>
              <p><strong>Service ID:</strong> ${s._id}</p>
              <p><strong>Service Provider:</strong> ${
                s.providerId?.name || ""
              } | ${s.providerId?.phone || ""}</p>
              <p><strong>Booked on:</strong> ${formatDate(s.createdAt)}</p>
              <p><strong>Car Model:</strong> ${s.carModel || ""}</p>
              <p><strong>Description:</strong> ${s.description || ""}</p>
              <p><strong>Cost:</strong> ₹${s.totalCost || 0}</p>
              <p><strong>Status:</strong> ${pastServiceStatusSpan(s)}</p>
              ${s.status === "Ready" ? ratingBlock(s) : ""}
              ${
                s.status === "Ready"
                  ? `<a href="/customer/service-receipt/${s._id}" target="_blank" class="download-btn">Download Receipt</a>`
                  : ""
              }
            </div>
          </li>`
            )
            .join("");
        }
      }

      function ratingBlock(s) {
        if (!s.rating) {
          return `<button class=\"rate-btn\" onclick=\"openRatingModal('${s._id}')\">Rate</button>`;
        }
        return `<p><strong>Your Rating:</strong> ${s.rating}/5</p>${
          s.review ? `<p><strong>Comment:</strong> ${s.review}</p>` : ""
        }`;
      }

      function statusSpan(status) {
        if (["pending", "confirmed", "shipped"].includes(status))
          return `<span style='color: orange;'>${status}</span>`;
        return `<span style='color: green;'>${status}</span>`;
      }

      function serviceStatusSpan(status, id) {
        if (status === "Open") {
          return `<span style='color: orange;'>Waiting for Confirmation</span><br><button class=\"cancel-btn\" onclick=\"cancelService('${id}')\">Cancel Service</button>`;
        }
        return `<span style='color: green;'>Confirmed</span>`;
      }

      function pastServiceStatusSpan(s) {
        if (s.status === "Ready")
          return `<span style='color: green;'>Completed</span>`;
        return `<span style='color: red;'>Rejected</span>`;
      }

      function formatDate(d) {
        if (!d) return "";
        return new Date(d).toLocaleDateString();
      }

      async function cancelOrder(id) {
        if (!confirm("Are you sure you want to cancel this order?")) return;
        try {
          const res = await fetch(`/customer/cancel-order/${id}`, {
            method: "POST",
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          if (res.ok) {
            // some cancel endpoint deletes order then redirects; we handle JSON gracefully
            const ct = res.headers.get("content-type") || "";
            if (ct.includes("application/json")) {
              const data = await res.json();
              if (!data.success) console.warn("Cancel order response:", data);
            }
            fetchHistory();
          } else {
            alert("Failed to cancel order");
          }
        } catch (err) {
          console.error(err);
          alert("Error cancelling order");
        }
      }

      async function cancelService(id) {
        if (!confirm("Cancel this service request?")) return;
        try {
          const res = await fetch(`/customer/cancel-service/${id}`, {
            method: "POST",
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          if (res.ok) {
            const ct = res.headers.get("content-type") || "";
            if (ct.includes("application/json")) {
              const data = await res.json();
              if (!data.success) console.warn("Cancel service response:", data);
            }
            fetchHistory();
          } else {
            alert("Failed to cancel service");
          }
        } catch (err) {
          console.error(err);
          alert("Error cancelling service");
        }
      }

      function openRatingModal(id) {
        document.getElementById("bookingId").value = id;
        document.getElementById("ratingModal").style.display = "flex";
      }
      function closeRatingModal() {
        document.getElementById("ratingModal").style.display = "none";
      }
      document
        .getElementById("closeRatingModal")
        .addEventListener("click", closeRatingModal);
      window.openRatingModal = openRatingModal;

      document
        .getElementById("ratingForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const bookingId = document.getElementById("bookingId").value;
          const rating = document.getElementById("rating").value;
          const review = document.getElementById("review").value;
          try {
            const res = await fetch(`/customer/rate-service/${bookingId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({ rating, review }),
            });
            if (res.status === 401) {
              window.location.href = "/login";
              return;
            }
            if (!res.ok) {
              alert("Failed to submit rating");
              return;
            }
            closeRatingModal();
            fetchHistory();
          } catch (err) {
            console.error(err);
            alert("Error submitting rating");
          }
        });

      fetchHistory();
    </script>
  </body>
</html>
