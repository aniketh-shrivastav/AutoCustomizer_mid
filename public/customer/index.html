<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AutoCustomizer Dashboard</title>
    <link rel="stylesheet" href="/styles/styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <div class="logo">
        <img
          style="height: 80px"
          src="/images3/logo2.jpg"
          alt="AutoCustomizer Logo"
        />
      </div>
      <nav>
        <ul class="nav-links">
          <li><a href="/">Home</a></li>
          <li><a href="/customer/index.html">Products</a></li>
          <li><a href="/customer/booking.html">Services</a></li>
          <li><a href="/customer/history.html">Order History</a></li>
          <li>
            <a href="/customer/cart.html" class="cart-link">
              <img src="/images/cart-icon.png" alt="Cart" />
              <span>Cart</span>
            </a>
          </li>
          <li><a href="/customer/profile.html">Profile</a></li>
          <li><a href="/logout">Logout</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="search-bar">
        <input
          type="text"
          id="search-input"
          placeholder="Search for car parts..."
        />
      </div>

      <section class="alert alert-info mx-3 mt-3" role="alert">
        <h5 class="mb-2">üõ†Ô∏è Important Instructions Before You Order</h5>
        <ul class="mb-2">
          <li>
            Please ensure that you <strong>update your profile</strong> before
            ordering products. An incomplete profile may cause errors during
            order placement.
          </li>
          <li>
            If you plan to <strong>book a service along with a product</strong>,
            it's recommended to book the service first to avoid any conflicts.
          </li>
        </ul>
        <p class="mb-0">Let's start customizing our car! üöó</p>
      </section>

      <h2>Available Car Parts</h2>
      <div class="parts-list" id="parts-list"></div>
    </main>

    <footer>
      <div class="footer-container">
        <div class="footer-section">
          <h3>Contact Us</h3>
          <p>Email: support@autocustomizer.com</p>
          <p>Phone: +123-456-7890</p>
          <p>Address: 123 Auto Street, Custom City</p>
        </div>
        <div class="footer-section">
          <h3>Follow Us</h3>
          <div class="social-icons">
            <a href="#"
              ><img src="/images/facebook-icon.png" alt="Facebook"
            /></a>
            <a href="#"><img src="/images/twitter-icon.png" alt="Twitter" /></a>
            <a href="#"
              ><img src="/images/instagram-icon.png" alt="Instagram"
            /></a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 AutoCustomizer. All Rights Reserved.</p>
      </div>
    </footer>

    <script>
      let allProducts = [];

      async function loadProducts() {
        try {
          const response = await fetch("/customer/api/index", {
            headers: { Accept: "application/json" },
          });
          if (response.status === 401) {
            // Session expired / not logged in
            window.location.href = "/login";
            return;
          }
          if (!response.ok) throw new Error("Failed to load products");
          const data = await response.json();
          allProducts = data.products || [];
          if (allProducts.length) {
            console.log(
              "Sample product IDs:",
              allProducts.slice(0, 3).map((p) => ({
                raw: p._id,
                asString: p._id && p._id.$oid ? p._id.$oid : p._id,
              }))
            );
          }
          renderProducts(allProducts);
          setupSearch();
        } catch (err) {
          console.error("Error loading products:", err);
          document.getElementById("parts-list").innerHTML =
            '<p class="text-danger">Failed to load products. Please refresh.</p>';
        }
      }

      function renderProducts(products) {
        const partsList = document.getElementById("parts-list");

        if (products.length === 0) {
          partsList.innerHTML = "<p>No products available.</p>";
          return;
        }

        partsList.innerHTML = products
          .map(
            (product) => `
                                <div class="part" data-name="${
                                  product.name || ""
                                }" data-category="${product.category || ""}">
                                    <div class="card mb-4 shadow-sm">
                                        <img src="${
                                          product.image ||
                                          "/images/placeholder.jpg"
                                        }" class="card-img-top" alt="${
              product.name || "Product"
            }">
                                        <div class="card-body">
                                            <h5 class="card-title">${
                                              product.name || "Unnamed Product"
                                            }</h5>
                                            <p class="card-text">‚Çπ${
                                              product.price || "0"
                                            }</p>
                                            <a href="/customer/product/${
                                              product._id
                                            }" class="btn btn-sm btn-outline-primary">View Details</a>
                                            <form action="/customer/cart/add" method="POST" class="add-to-cart-form mt-3">
                                                <input type="hidden" name="id" value="${
                                                  product._id
                                                }">
                                                <button type="submit" class="btn btn-primary w-100">Add to Cart</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                        `
          )
          .join("");

        // Attach AJAX interception to forms
        document.querySelectorAll(".add-to-cart-form").forEach((form) => {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = form.querySelector("button");
            const original = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Adding...";
            try {
              const id = form.querySelector('input[name="id"]').value;
              const response = await fetch(form.action, {
                method: "POST",
                headers: {
                  Accept: "application/json",
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ id }),
              });
              if (response.status === 401) {
                window.location.href = "/login";
                return;
              }
              const result = await response.json();
              if (result.success) {
                alert("Product added to cart successfully! üõí");
              } else {
                alert(
                  "Failed to add product: " +
                    (result.message || "Unknown error")
                );
              }
            } catch (err) {
              console.error("Add to cart error:", err);
              alert("Error adding product to cart. Try again.");
            } finally {
              btn.disabled = false;
              btn.textContent = original;
            }
          });
        });
      }

      function setupSearch() {
        const searchInput = document.getElementById("search-input");
        searchInput.addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase().trim();

          const filteredProducts = allProducts.filter(
            (product) =>
              (product.name || "").toLowerCase().includes(searchTerm) ||
              (product.category || "").toLowerCase().includes(searchTerm)
          );

          renderProducts(filteredProducts);
        });
      }

      // (Removed standalone addToCart; using form interception for parity with EJS markup)

      // Load products when page loads
      loadProducts();
    </script>
  </body>
</html>
