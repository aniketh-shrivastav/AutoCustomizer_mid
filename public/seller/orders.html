<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Order Management | AutoCustomizer</title>
    <link href="/Css/CStyle.css" rel="stylesheet" />
    <link href="/newstyle.css" rel="stylesheet" />
    <link href="/Css/sellerBase.css" rel="stylesheet" />
  </head>
  <body class="seller-page">
    <nav class="navbar">
      <div class="brand">AutoCustomizer</div>
      <ul>
        <li><a href="/seller/dashboard.html">Dashboard</a></li>
        <li><a href="/seller/profileSettings">Profile Settings</a></li>
        <li><a href="/seller/productmanagement">Products</a></li>
        <li><a href="/seller/orders.html" class="active">Orders</a></li>

        <li><a href="/logout">Logout</a></li>
      </ul>
    </nav>

    <header>
      <h1>Order Management</h1>
    </header>

    <main class="seller-main">
      <div
        class="container"
        style="
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          padding: 20px;
        "
      >
        <h2 style="margin-top: 0; color: #6a11cb">Orders</h2>
        <div style="overflow-x: auto">
          <table
            id="ordersTable"
            style="width: 100%; border-collapse: collapse"
          >
            <thead>
              <tr>
                <th style="padding: 10px; background: #6a11cb; color: #fff">
                  Order ID
                </th>
                <th style="padding: 10px; background: #6a11cb; color: #fff">
                  Customer
                </th>
                <th style="padding: 10px; background: #6a11cb; color: #fff">
                  Product
                </th>
                <th style="padding: 10px; background: #6a11cb; color: #fff">
                  Qty
                </th>
                <th style="padding: 10px; background: #6a11cb; color: #fff">
                  Delivery Address
                </th>
                <th style="padding: 10px; background: #6a11cb; color: #fff">
                  Status
                </th>
                <th style="padding: 10px; background: #6a11cb; color: #fff">
                  Action
                </th>
              </tr>
            </thead>
            <tbody id="ordersBody">
              <tr>
                <td colspan="7" style="text-align: center; padding: 20px">
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <footer class="seller-footer">
      <p>&copy; 2025 AutoCustomizer | All Rights Reserved</p>
    </footer>

    <script>
      function statusBadge(status) {
        const cls = status.toLowerCase();
        return `<span class="status ${cls}" style="padding:6px 12px;border-radius:16px;color:#fff;display:inline-block;background:${badgeColor(
          cls
        )};font-size:0.85rem;">${status}</span>`;
      }
      function badgeColor(s) {
        switch (s) {
          case "pending":
            return "#FFC107";
          case "confirmed":
            return "#7e57c2";
          case "shipped":
            return "#2196F3";
          case "delivered":
            return "#4CAF50";
          case "cancelled":
            return "#e53935";
          default:
            return "#546e7a";
        }
      }

      async function loadOrders() {
        try {
          const res = await fetch("/seller/api/orders", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location = "/login";
            return;
          }
          const data = await res.json();
          const tbody = document.getElementById("ordersBody");
          if (!data.success) throw new Error(data.message || "Failed");
          if (!data.orders.length) {
            tbody.innerHTML =
              '<tr><td colspan="7" style="text-align:center;color:#888;padding:25px;">No orders available.</td></tr>';
            return;
          }
          tbody.innerHTML = "";
          data.orders.forEach((o, index) => {
            const disabled =
              o.status === "delivered" || o.status === "cancelled";
            const row = document.createElement("tr");
            // Use unique ID for each row to ensure independence
            const uniqueId = o.uniqueId || `${o.orderId}-${o.productId}-${index}`;
            const rowId = `order-row-${uniqueId}`;
            row.id = rowId;
            row.innerHTML = `
            <td style="padding:8px;border-bottom:1px solid #ddd;">${
              o.orderId
            }</td>
            <td style="padding:8px;border-bottom:1px solid #ddd;">${
              o.customerName
            }</td>
            <td style="padding:8px;border-bottom:1px solid #ddd;">${
              o.productName
            }</td>
            <td style="padding:8px;border-bottom:1px solid #ddd;">${
              o.quantity
            }</td>
            <td style="padding:8px;border-bottom:1px solid #ddd;">${
              o.deliveryAddress
            }</td>
            <td style="padding:8px;border-bottom:1px solid #ddd;" data-status-cell>${statusBadge(
              o.status
            )}</td>
            <td style="padding:8px;border-bottom:1px solid #ddd;">
              <div class="form-inline" style="background:transparent;padding:0;margin:0;">
                <select 
                  class="status-select" 
                  data-unique-id="${uniqueId}"
                  data-order-id="${o.orderId}" 
                  data-product-id="${o.productId || ''}"
                  data-item-index="${o.itemIndex !== undefined ? o.itemIndex : ''}"
                  data-original-status="${o.status}"
                  ${disabled ? "disabled" : ""} 
                  style="padding:6px;border-radius:6px;">
                  ${[
                    "pending",
                    "confirmed",
                    "shipped",
                    "delivered",
                    "cancelled",
                  ]
                    .map(
                      (s) =>
                        `<option value="${s}" ${
                          o.status === s ? "selected" : ""
                        }>${capitalize(s)}</option>`
                    )
                    .join("")}
                </select>
                <button 
                  class="btn update-status-btn" 
                  data-unique-id="${uniqueId}"
                  data-order-id="${o.orderId}" 
                  data-product-id="${o.productId || ''}"
                  data-item-index="${o.itemIndex !== undefined ? o.itemIndex : ''}"
                  data-original-status="${o.status}"
                  ${disabled ? "disabled" : ""}
                  disabled
                  style="margin-left:8px;opacity:0.5;cursor:not-allowed;">Update</button>
              </div>
            </td>`;
            tbody.appendChild(row);
          });
          attachHandlers();
        } catch (err) {
          console.error(err);
          document.getElementById("ordersBody").innerHTML =
            '<tr><td colspan="7" style="text-align:center;color:red;padding:25px;">Failed to load orders.</td></tr>';
        }
      }

      function capitalize(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
      }

      function attachHandlers() {
        // Attach handlers to each Update button - scoped to its specific row using unique ID
        document.querySelectorAll("button.update-status-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            e.preventDefault();
            const uniqueId = btn.getAttribute("data-unique-id");
            const orderId = btn.getAttribute("data-order-id");
            
            // Find the select within the same row using unique ID to ensure independence
            const row = btn.closest("tr");
            const select = row.querySelector(`select.status-select[data-unique-id="${uniqueId}"]`);
            
            if (!select || !orderId || !uniqueId) {
              console.error("Could not find select, orderId, or uniqueId");
              return;
            }
            
            const newStatus = select.value;
            const originalStatus = select.getAttribute("data-original-status");
            
            // Don't update if status hasn't changed
            if (newStatus === originalStatus) {
              alert("Status unchanged. No update needed.");
              return;
            }
            
            // Disable button during update
            btn.disabled = true;
            btn.textContent = "Updating...";
            
            try {
              // Get productId and itemIndex for per-item status update
              const productId = select.getAttribute("data-product-id");
              const itemIndex = select.getAttribute("data-item-index");
              
              const res = await fetch(`/seller/orders/${orderId}/status`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                  newStatus,
                  productId: productId || undefined,
                  itemIndex: itemIndex !== '' ? parseInt(itemIndex) : undefined
                }),
              });
              
              const out = await res.json();
              
              if (!out.success) {
                alert(out.message || "Failed to update status");
                // Revert select to original value
                select.value = originalStatus;
                updateButtonState(btn, select, originalStatus);
                return;
              }
              
              // Update badge in the same row only
              const statusCell = row.querySelector("td[data-status-cell]");
              if (statusCell) {
                statusCell.innerHTML = statusBadge(newStatus);
              }
              
              // Update the original status attribute
              select.setAttribute("data-original-status", newStatus);
              btn.setAttribute("data-original-status", newStatus);
              
              // Update button state
              updateButtonState(btn, select, newStatus);
              
              alert("Order status updated successfully!");
              
              // If status changed to delivered, notify user to refresh dashboard for earnings update
              if (newStatus === "delivered") {
                console.log("Order marked as delivered - dashboard earnings will update on next view");
              }
              
              // Reload orders to reflect changes
              setTimeout(() => {
                loadOrders();
              }, 500);
            } catch (e) {
              console.error("Error updating order:", e);
              alert("Error updating order. Please try again.");
              // Revert select to original value on error
              select.value = originalStatus;
              updateButtonState(btn, select, originalStatus);
            }
          });
        });
        
        // Handle dropdown changes - enable/disable update button and show visual feedback
        document.querySelectorAll("select.status-select").forEach((select) => {
          select.addEventListener("change", function() {
            const uniqueId = this.getAttribute("data-unique-id");
            const row = this.closest("tr");
            const btn = row.querySelector(`button.update-status-btn[data-unique-id="${uniqueId}"]`);
            const originalStatus = this.getAttribute("data-original-status");
            const currentStatus = this.value;
            const isDisabled = this.disabled;
            
            // Enable/disable button based on whether status changed
            // Button should be enabled for ANY status change (except if dropdown is disabled)
            if (btn) {
              if (currentStatus !== originalStatus && !isDisabled) {
                // Status changed and dropdown is not disabled - enable button
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
                this.style.borderColor = "#ffc107";
              } else {
                // Status unchanged or dropdown disabled - disable button
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                this.style.borderColor = "";
              }
            }
          });
        });
      }
      
      function updateButtonState(btn, select, status) {
        const originalStatus = select.getAttribute("data-original-status");
        const currentStatus = select.value;
        
        // Disable if final status or if status matches original
        if (["delivered", "cancelled"].includes(status)) {
          select.disabled = true;
          btn.disabled = true;
          btn.style.opacity = "0.5";
          btn.style.cursor = "not-allowed";
        } else if (currentStatus === originalStatus) {
          btn.disabled = true;
          btn.style.opacity = "0.5";
          btn.style.cursor = "not-allowed";
        } else {
          btn.disabled = false;
          btn.style.opacity = "1";
          btn.style.cursor = "pointer";
        }
        btn.textContent = "Update";
      }

      document.addEventListener("DOMContentLoaded", loadOrders);
    </script>
  </body>
</html>
