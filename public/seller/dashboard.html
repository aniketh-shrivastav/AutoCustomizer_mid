<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Seller Dashboard | AutoCustomizer</title>
    <link href="/Css/CStyle.css" rel="stylesheet" />
    <link href="/newstyle.css" rel="stylesheet" />
    <link href="/Css/sellerBase.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="seller-page">
    <!-- Unified navbar using existing .navbar styles from CStyle.css -->
    <nav class="navbar">
      <div class="brand">AutoCustomizer</div>
      <ul>
        <li><a href="/seller/dashboard.html" class="active">Dashboard</a></li>
        <li><a href="/seller/profileSettings">Profile Settings</a></li>
        <li><a href="/seller/productmanagement">Products</a></li>
        <li><a href="/seller/orders">Orders</a></li>

        <li><a href="/logout">Logout</a></li>
      </ul>
    </nav>

    <header>
      <h1>AutoCustomizer Seller Dashboard</h1>
    </header>

    <main class="seller-main">
      <section class="stats" id="statsCards">
        <div class="card">
          <h2>Total Sales</h2>
          <p id="totalSalesVal">...</p>
        </div>
        <div class="card">
          <h2>Total Earnings</h2>
          <p id="totalEarningsVal">...</p>
        </div>
        <div class="card">
          <h2>Total Orders</h2>
          <p id="totalOrdersVal">...</p>
        </div>
      </section>

      <section class="alerts" style="margin-top: 30px">
        <h2>Stock Alerts</h2>
        <div id="stockAlerts"></div>
      </section>

      <div
        class="orders-and-chart"
        style="display: flex; flex-wrap: wrap; gap: 30px; margin-top: 30px"
      >
        <section class="orders" style="flex: 1; min-width: 320px">
          <h2>Recent Orders</h2>
          <div id="recentOrdersWrap"></div>
        </section>
        <section class="pie-chart" style="flex: 1; min-width: 320px">
          <h2>Order Status Distribution</h2>
          <div style="position: relative; height: 300px">
            <canvas id="orderStatusChart"></canvas>
          </div>
        </section>
      </div>
    </main>

    <footer class="seller-footer">
      <p>&copy; 2025 AutoCustomizer | All Rights Reserved</p>
    </footer>

    <script>
      async function loadDashboard() {
        try {
          const res = await fetch("/seller/api/dashboard", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          const data = await res.json();
          if (!data.success)
            throw new Error(data.message || "Failed to load dashboard");

          renderStats(data);
          renderStockAlerts(data.stockAlerts || []);
          renderRecentOrders(data.recentOrders || []);
          renderChart(data.statusDistribution || {});
        } catch (err) {
          console.error(err);
          document.body.insertAdjacentHTML(
            "beforeend",
            '<p style="color:red;text-align:center;">Failed to load dashboard.</p>'
          );
        }
      }

      function renderStats(d) {
        document.getElementById("totalSalesVal").textContent = d.totalSales;
        document.getElementById("totalEarningsVal").textContent =
          "â‚¹" + d.totalEarnings;
        document.getElementById("totalOrdersVal").textContent = d.totalOrders;
      }

      function renderStockAlerts(alerts) {
        const container = document.getElementById("stockAlerts");
        if (!alerts.length) {
          container.innerHTML = "<p>All products are well-stocked.</p>";
          return;
        }
        const list = document.createElement("ul");
        alerts.forEach((a) => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${a.product}</strong> - Only ${a.stock} left!`;
          list.appendChild(li);
        });
        container.innerHTML = "";
        container.appendChild(list);
      }

      function renderRecentOrders(orders) {
        const wrap = document.getElementById("recentOrdersWrap");
        if (!orders.length) {
          wrap.innerHTML = "<p>No recent orders available.</p>";
          return;
        }
        const rows = orders
          .map(
            (o) =>
              `<tr><td>${o.orderId}</td><td>${o.customer}</td><td>${o.status}</td></tr>`
          )
          .join("");
        wrap.innerHTML = `
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #ccc;">Order ID</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #ccc;">Customer</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #ccc;">Status</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
      }

      function renderChart(dist) {
        const labels = Object.keys(dist);
        const values = Object.values(dist);
        const ctx = document
          .getElementById("orderStatusChart")
          .getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                data: values,
                backgroundColor: [
                  "#6a11cb",
                  "#2575fc",
                  "#ff6f61",
                  "#2ecc71",
                  "#f1c40f",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }

      document.addEventListener("DOMContentLoaded", loadDashboard);
    </script>
  </body>
</html>
