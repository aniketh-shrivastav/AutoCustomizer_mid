<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Payments | Manager Panel</title>
    <link rel="stylesheet" href="/styles/admin-consistent.css" />
    <style>
      /* Tabs mimic payments.ejs but harmonize spacing with existing design */
      .tab-bar {
        margin-top: 10px;
      }
      .tab-button {
        padding: 10px 18px;
        margin-right: 10px;
        border: none;
        cursor: pointer;
        background: #ddd;
        border-radius: 8px;
        font-weight: 500;
        transition: background 0.25s ease, color 0.25s ease;
      }
      .tab-button:hover {
        background: #cfcfcf;
      }
      .tab-button.active {
        background: #2ecc71;
        color: #fff;
      }
      .tab-content {
        display: none;
        margin-top: 20px;
      }
      .tab-content.active {
        display: block;
      }
      /* Let shared .order-table styles from admin-consistent.css control appearance */
      table.order-table {
        width: 100%;
      }
      table.order-table td {
        vertical-align: top;
      }
      .loading {
        margin-top: 20px;
      }
      .error {
        color: var(--danger-color);
        margin-top: 15px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <div class="logo"><h2>Manager's Panel</h2></div>
      <nav>
        <ul>
          <li><a href="/manager/dashboard.html">Dashboard</a></li>
          <li><a href="/manager/users.html">User Management</a></li>
          <li><a href="/manager/services.html">User Profiles</a></li>
          <li><a href="/manager/orders.html">Orders & Bookings</a></li>
          <li><a class="active" href="/manager/payments.html">Payments</a></li>
          <li><a href="/manager/support.html">Support</a></li>
          <li><a href="/logout">Logout</a></li>
        </ul>
      </nav>
    </div>

    <div class="main-content container" style="margin-top: 60px">
      <h1>Payments Overview</h1>

      <div class="tab-bar">
        <button class="tab-button active" data-target="ordersTab">
          Orders
        </button>
        <button class="tab-button" data-target="servicesTab">
          Service Orders
        </button>
      </div>

      <div id="feedback" class="loading">Loading payments data...</div>

      <div id="ordersTab" class="tab-content active">
        <table class="order-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Seller(s)</th>
              <th>Products</th>
              <th>Total Cost</th>
              <th>Commission (20%)</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>

      <div id="servicesTab" class="tab-content">
        <table class="order-table">
          <thead>
            <tr>
              <th>Booking ID</th>
              <th>Customer</th>
              <th>Provider</th>
              <th>Services</th>
              <th>Total Cost</th>
              <th>Commission (20%)</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="servicesBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      function formatDate(d) {
        try {
          return new Date(d).toDateString();
        } catch {
          return "N/A";
        }
      }

      async function loadPayments() {
        const feedback = document.getElementById("feedback");
        try {
          const res = await fetch("/manager/api/payments", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401 || res.status === 403) {
            window.location.href = "/login";
            return;
          }
          if (!res.ok) throw new Error("Failed to load payments");
          const data = await res.json();
          feedback.textContent = "";
          renderOrders(data.orders || []);
          renderServiceOrders(data.serviceOrders || []);
        } catch (err) {
          console.error(err);
          feedback.className = "error";
          feedback.textContent = "Error loading payments data.";
        }
      }

      function renderOrders(orders) {
        const tbody = document.getElementById("ordersBody");
        if (!orders.length) {
          tbody.innerHTML = '<tr><td colspan="7">No orders found.</td></tr>';
          return;
        }
        tbody.innerHTML = orders
          .map((o) => {
            const sellers = [
              ...new Set(
                (o.items || []).map((i) => i.seller?.name).filter(Boolean)
              ),
            ].join(", ");
            const products = (o.items || [])
              .map((i) => `<div>${i.name} (x${i.quantity})</div>`)
              .join("");
            const total =
              typeof o.totalAmount === "number"
                ? o.totalAmount.toFixed(2)
                : "0.00";
            const commission = (parseFloat(total) * 0.2).toFixed(2);
            return `<tr>
          <td>${o._id}</td>
          <td>${o.userId?.name || "N/A"}</td>
          <td>${sellers}</td>
          <td>${products}</td>
          <td>₹${total}</td>
          <td>₹${commission}</td>
          <td>${formatDate(o.placedAt)}</td>
        </tr>`;
          })
          .join("");
      }

      function renderServiceOrders(serviceOrders) {
        const tbody = document.getElementById("servicesBody");
        if (!serviceOrders.length) {
          tbody.innerHTML =
            '<tr><td colspan="7">No service bookings found.</td></tr>';
          return;
        }
        tbody.innerHTML = serviceOrders
          .map((s) => {
            const total = s.totalCost ? s.totalCost.toFixed(2) : "N/A";
            const commission = s.totalCost
              ? (s.totalCost * 0.2).toFixed(2)
              : "N/A";
            return `<tr>
          <td>${s._id}</td>
          <td>${s.customerId?.name || "N/A"}</td>
          <td>${s.providerId?.name || "N/A"}</td>
          <td>${(s.selectedServices || []).join(", ")}</td>
          <td>₹${total}</td>
          <td>₹${commission}</td>
          <td>${formatDate(s.date)}</td>
        </tr>`;
          })
          .join("");
      }

      // Tab switching
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("tab-button")) {
          document
            .querySelectorAll(".tab-button")
            .forEach((b) => b.classList.remove("active"));
          e.target.classList.add("active");
          const target = e.target.getAttribute("data-target");
          document
            .querySelectorAll(".tab-content")
            .forEach((tab) => tab.classList.remove("active"));
          document.getElementById(target).classList.add("active");
        }
      });

      loadPayments();
    </script>
  </body>
</html>
