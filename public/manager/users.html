<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management - Admin</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="/styles/admin-consistent.css" />
    <style>
      .filter-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      .filter-btn {
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        border-radius: 5px;
        background-color: black;
        color: white;
      }
      .filter-btn.active {
        background-color: #2ecc71;
        color: #fff;
      }
      .search-box {
        padding: 8px;
        width: 250px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .user-section {
        display: none;
      }
      .user-section.active {
        display: block;
      }
      .suspended-user {
        background-color: #f8d7da !important;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <div class="logo"><h2>Manager's Panel</h2></div>
      <nav>
        <ul>
          <li><a href="/manager/dashboard.html">Dashboard</a></li>
          <li>
            <a class="active" href="/manager/users.html">User Management</a>
          </li>
          <li><a href="/manager/services.html">User Profiles</a></li>
          <li><a href="/manager/orders.html">Orders & Bookings</a></li>
          <li><a href="/manager/payments.html">Payments</a></li>
          <li><a href="/manager/support.html">Support</a></li>
          <li><a href="/logout">Logout</a></li>
        </ul>
      </nav>
    </div>

    <div class="main-content">
      <h2>User Management</h2>
      <div class="filter-container">
        <input
          type="text"
          id="searchInput"
          class="search-box"
          placeholder="Search users..."
        />
        <button class="filter-btn active" data-role="all">All Users</button>
        <button class="filter-btn" data-role="customer">Customers</button>
        <button class="filter-btn" data-role="seller">Sellers</button>
        <button class="filter-btn" data-role="service-provider">
          Service Providers
        </button>
        <button class="filter-btn" data-role="manager">Managers</button>
      </div>

      <!-- Add Manager UI -->
      <div class="add-manager" style="margin: 10px 0 20px;">
        <button id="toggleAddManager" class="btn btn-view">+ Add Manager</button>
        <form id="addManagerForm" style="display:none; margin-top: 12px; max-width: 560px;">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <input id="mgrName" placeholder="Full name" required aria-describedby="mgrNameErr" style="flex:1; min-width:200px; padding:8px; border:1px solid #ccc; border-radius:8px;" />
            <input id="mgrEmail" type="email" placeholder="Email" required aria-describedby="mgrEmailErr" style="flex:1; min-width:220px; padding:8px; border:1px solid #ccc; border-radius:8px;" />
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:4px;">
            <small id="mgrNameErr" style="color:#e74c3c; min-height:16px; flex:1;"></small>
            <small id="mgrEmailErr" style="color:#e74c3c; min-height:16px; flex:1;"></small>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
            <input id="mgrPhone" placeholder="Phone (10 digits)" inputmode="numeric" pattern="\d{10}" aria-describedby="mgrPhoneErr" style="flex:1; min-width:200px; padding:8px; border:1px solid #ccc; border-radius:8px;" />
            <input id="mgrPassword" type="password" placeholder="Password (min 6)" minlength="6" required aria-describedby="mgrPasswordErr" style="flex:1; min-width:220px; padding:8px; border:1px solid #ccc; border-radius:8px;" />
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:4px;">
            <small id="mgrPhoneErr" style="color:#e74c3c; min-height:16px; flex:1;"></small>
            <small id="mgrPasswordErr" style="color:#e74c3c; min-height:16px; flex:1;"></small>
          </div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button type="submit" id="createManagerBtn" class="btn btn-approve" disabled>Create Manager</button>
            <button type="button" id="cancelAddManager" class="btn btn-suspend">Cancel</button>
          </div>
          <div id="addManagerMsg" class="status" style="margin-top:6px;"></div>
        </form>
      </div>

      <div
        id="error"
        style="
          display: none;
          color: #e74c3c;
          font-weight: bold;
          margin-bottom: 10px;
        "
      ></div>
      <div id="loading">Loading users...</div>
      <div id="userTables" style="display: none"></div>
    </div>

    <script>
      let allUsers = [];
      async function fetchUsers() {
        const resp = await fetch("/manager/api/users", {
          headers: { Accept: "application/json" },
        });
        if (resp.status === 401 || resp.status === 403) {
          window.location.href = "/login";
          return [];
        }
        if (!resp.ok) throw new Error("Failed to load users");
        const data = await resp.json();
        return data.users || [];
      }

      function buildUserSections(users) {
        const container = document.getElementById("userTables");
        container.innerHTML = "";
        const roles = ["customer", "seller", "service-provider", "manager"];
        roles.forEach((role) => {
          const section = document.createElement("div");
          section.className = "user-section " + role + "-section";
          section.dataset.role = role;
          const filtered = users.filter((u) => u.role === role);
          let rows = filtered
            .map((u) => {
              const actions =
                u.role === "manager"
                  ? "<span>Not Allowed</span>"
                  : !u.suspended
                  ? `<button class="btn btn-suspend" data-action="suspend" data-user-id="${u._id}">Suspend</button>`
                  : `<button class="btn btn-restore" data-action="restore" data-user-id="${u._id}">Restore</button>`;
              const statusBadge = u.suspended
                ? '<span class="badge badge-danger">Suspended</span>'
                : '<span class="badge badge-success">Active</span>';
              return `<tr class="${u.suspended ? "suspended-user" : ""}">
                    <td>${u._id}</td>
                    <td>${u.name || ""}</td>
                    <td>${u.email || ""}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                  </tr>`;
            })
            .join("");
          if (!rows)
            rows = '<tr><td colspan="5">No users in this category.</td></tr>';
          section.innerHTML = `<h3>${
            role.charAt(0).toUpperCase() + role.slice(1).replace("-", " ")
          }</h3>
          <div class="table-responsive"><table class="user-table"><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Status</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table></div>`;
          container.appendChild(section);
        });
      }

      function applySearchFilter() {
        const term = document.getElementById("searchInput").value.toLowerCase();
        document.querySelectorAll(".user-table tbody tr").forEach((row) => {
          row.style.display = row.innerText.toLowerCase().includes(term)
            ? ""
            : "none";
        });
      }

      function showRole(role) {
        document.querySelectorAll(".user-section").forEach((sec) => {
          if (role === "all") {
            sec.classList.add("active");
          } else {
            sec.classList.toggle("active", sec.dataset.role === role);
          }
        });
      }

      function attachFilterButtons() {
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".filter-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            showRole(btn.dataset.role);
          });
        });
      }

      function attachSearch() {
        document
          .getElementById("searchInput")
          .addEventListener("keyup", applySearchFilter);
      }

      function attachActions(users) {
        document
          .getElementById("userTables")
          .addEventListener("click", async (e) => {
            const btn = e.target.closest("button[data-action]");
            if (!btn) return;
            const id = btn.getAttribute("data-user-id");
            const action = btn.getAttribute("data-action");
            const confirmMsg =
              action === "suspend"
                ? "Are you sure you want to suspend this user?"
                : "Are you sure you want to restore this user?";
            if (!confirm(confirmMsg)) return;
            try {
              const resp = await fetch(`/manager/users/${action}/${id}`, {
                method: "POST",
                headers: {
                  Accept: "application/json",
                  "Content-Type": "application/json",
                },
              });
              if (resp.status === 401 || resp.status === 403) {
                window.location.href = "/login";
                return;
              }
              const data = await resp.json();
              if (!resp.ok || !data.success)
                throw new Error(data.message || "Action failed");
              // Response does not include updated user object, so toggle manually
              const idx = users.findIndex((u) => u._id === id);
              if (idx !== -1) {
                users[idx].suspended = action === "suspend";
              }
              buildUserSections(users);
              showRole(
                document.querySelector(".filter-btn.active").dataset.role
              );
              applySearchFilter();
            } catch (err) {
              displayError(err.message);
            }
          });
      }

      function displayError(msg) {
        const el = document.getElementById("error");
        el.textContent = msg;
        el.style.display = "block";
      }

      async function init() {
        try {
          allUsers = await fetchUsers();
          document.getElementById("loading").style.display = "none";
          document.getElementById("userTables").style.display = "block";
          buildUserSections(allUsers);
          showRole("all");
          attachFilterButtons();
          attachSearch();
          attachActions(allUsers);
        } catch (err) {
          document.getElementById("loading").style.display = "none";
          displayError(err.message || "Failed to load users");
        }
      }

      // Add Manager handlers
      document.getElementById('toggleAddManager').addEventListener('click', () => {
        const form = document.getElementById('addManagerForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
      });
      document.getElementById('cancelAddManager').addEventListener('click', () => {
        const form = document.getElementById('addManagerForm');
        form.style.display = 'none';
      });

      // Real-time DOM validation for Add Manager
      const mgrNameEl = document.getElementById('mgrName');
      const mgrEmailEl = document.getElementById('mgrEmail');
      const mgrPhoneEl = document.getElementById('mgrPhone');
      const mgrPassEl = document.getElementById('mgrPassword');
      const btnCreate = document.getElementById('createManagerBtn');
      const errName = document.getElementById('mgrNameErr');
      const errEmail = document.getElementById('mgrEmailErr');
      const errPhone = document.getElementById('mgrPhoneErr');
      const errPass = document.getElementById('mgrPasswordErr');

      const nameRegex = /^[A-Za-z\s.-]{2,}$/;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      function setFieldValidity(input, errorEl, isValid, message) {
        if (isValid) {
          errorEl.textContent = '';
          input.style.borderColor = '#ccc';
          input.setAttribute('aria-invalid', 'false');
        } else {
          errorEl.textContent = message;
          input.style.borderColor = '#e74c3c';
          input.setAttribute('aria-invalid', 'true');
        }
      }

      function validateManagerForm() {
        // Sanitize phone to digits
        if (mgrPhoneEl.value) {
          mgrPhoneEl.value = mgrPhoneEl.value.replace(/\D/g, '').slice(0, 10);
        }

        const nameOk = nameRegex.test(mgrNameEl.value.trim());
        setFieldValidity(mgrNameEl, errName, nameOk, 'Enter a valid name (letters, spaces, . -)');

        const emailOk = emailRegex.test(mgrEmailEl.value.trim());
        setFieldValidity(mgrEmailEl, errEmail, emailOk, 'Enter a valid email');

        const phoneVal = mgrPhoneEl.value.trim();
        const phoneOk = phoneVal === '' || /^\d{10}$/.test(phoneVal);
        setFieldValidity(mgrPhoneEl, errPhone, phoneOk, 'Phone must be 10 digits');

        const passOk = (mgrPassEl.value || '').length >= 6;
        setFieldValidity(mgrPassEl, errPass, passOk, 'Password must be 6+ characters');

        const allOk = nameOk && emailOk && phoneOk && passOk;
        btnCreate.disabled = !allOk;
        return allOk;
      }

      [mgrNameEl, mgrEmailEl, mgrPhoneEl, mgrPassEl].forEach(el => {
        el.addEventListener('input', validateManagerForm);
        el.addEventListener('blur', validateManagerForm);
      });

      document.getElementById('addManagerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!validateManagerForm()) return;
        const msg = document.getElementById('addManagerMsg');
        msg.textContent = '';
        const name = document.getElementById('mgrName').value.trim();
        const email = document.getElementById('mgrEmail').value.trim();
        const phone = document.getElementById('mgrPhone').value.trim();
        const password = document.getElementById('mgrPassword').value;
        msg.style.color = '#333';
        msg.textContent = 'Creating manager...';
        try {
          const resp = await fetch('/manager/users/create-manager', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ name, email, phone, password })
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok || !data.success) {
            throw new Error(data.message || 'Create failed');
          }
          // Update local list and UI
          allUsers.push(data.user);
          buildUserSections(allUsers);
          // Switch to Managers tab so it’s visible immediately
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          const mgrBtn = document.querySelector('.filter-btn[data-role="manager"]');
          if (mgrBtn) mgrBtn.classList.add('active');
          showRole('manager');
          applySearchFilter();
          msg.style.color = 'green';
          msg.textContent = 'Manager created successfully.';
          // Optional: clear fields
          document.getElementById('mgrPassword').value = '';
          validateManagerForm();
        } catch (err) {
          msg.style.color = 'red';
          msg.textContent = err.message || 'Error creating manager';
        }
      });

      function highlightActiveNav() {
        const links = document.querySelectorAll(".navbar nav a");
        const path = window.location.pathname;
        links.forEach((a) => {
          const href = a.getAttribute("href");
          if (href === path) a.classList.add("active");
        });
      }

      highlightActiveNav();
      init();
    </script>
  </body>
</html>
