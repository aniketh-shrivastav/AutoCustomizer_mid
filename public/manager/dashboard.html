<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard (Static)</title>
    <link rel="stylesheet" href="/styles/admin-consistent.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  </head>
  <body>
    <div class="navbar">
      <div class="logo"><h2>Manager's Panel</h2></div>
      <div id="manager-nav"></div>
    </div>

    <div class="main-content">
      <h1>Dashboard Overview</h1>
      <div class="stats-grid" id="stats-grid">
        <!-- Filled by JS -->
      </div>

      <div class="charts-container">
        <div class="chart-wrapper">
          <h2>User Distribution</h2>
          <div class="chart-box">
            <canvas id="userDistributionChart"></canvas>
          </div>
        </div>
        <div class="chart-wrapper">
          <h2>Monthly Revenue & Commission</h2>
          <div class="chart-box"><canvas id="revenueChart"></canvas></div>
        </div>
        <div class="chart-wrapper">
          <h2>User Growth</h2>
          <div class="chart-box"><canvas id="userGrowthChart"></canvas></div>
        </div>
      </div>

      <div class="product-tabs">
        <h2>Product Approval</h2>
        <div class="tabs">
          <button class="tab-btn active" data-tab="pending">Pending</button>
          <button class="tab-btn" data-tab="approved">Approved</button>
          <button class="tab-btn" data-tab="rejected">Rejected</button>
        </div>
        <div class="tab-content" id="pending" style="display: block"></div>
        <div class="tab-content" id="approved" style="display: none"></div>
        <div class="tab-content" id="rejected" style="display: none"></div>
      </div>
    </div>

    <script>
      // Lightweight helper (no module system to keep compatibility)
      function injectNav() {
        const html = `<nav><ul>
    <li><a href="/manager/dashboard.html">Dashboard</a></li>
  <li><a href="/manager/users.html">User Management</a></li>
  <li><a href="/manager/services.html">User Profiles</a></li>
  <li><a href="/manager/orders.html">Orders & Bookings</a></li>
  <li><a href="/manager/payments.html">Payments</a></li>
    <li><a href="/manager/support.html">Support</a></li>
    <li><a href="/logout">Logout</a></li>
  </ul></nav>`;
        const mount = document.getElementById("manager-nav");
        if (mount) mount.innerHTML = html;
      }

      function formatCurrency(v) {
        return "â‚¹" + Number(v || 0).toFixed(2);
      }

      async function loadDashboard() {
        try {
          const res = await fetch("/manager/api/dashboard", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          if (res.status === 403) {
            window.location.href = "/login";
            return;
          }
          const contentType = res.headers.get("content-type") || "";
          if (!contentType.includes("application/json")) {
            window.location.href = "/login";
            return;
          }
          if (!res.ok) throw new Error("Network error");
          const data = await res.json();
          renderStats(data);
          renderProductTables(data);
          setupTabs();
          drawCharts(data.userCounts);
        } catch (err) {
          console.error(err);
          document
            .querySelector(".main-content")
            .insertAdjacentHTML(
              "afterbegin",
              '<p style="color:red">Failed to load dashboard data.</p>'
            );
        }
      }

      function renderStats(data) {
        document.getElementById("stats-grid").innerHTML = `
    <div class="stat-card"><h3>Total Users</h3><p class="number">${
      data.totalUsers
    }</p></div>
    <div class="stat-card"><h3>Total Earnings</h3><p class="number">${formatCurrency(
      data.totalEarnings
    )}</p></div>
    <div class="stat-card"><h3>Commission (20%)</h3><p class="number">${formatCurrency(
      data.commission
    )}</p></div>`;
      }

      function tableRows(products, type) {
        if (!products || !products.length)
          return '<p class="empty-state">No ' + type + " products.</p>";
        return (
          `<div class="table-responsive"><table class="generic-table"><thead><tr><th>Image</th><th>Name</th><th>Seller</th><th>Price</th><th>Category</th><th>Brand</th><th>Description</th><th>Stock</th><th>Actions</th></tr></thead><tbody>` +
          products
            .map(
              (p) => `<tr>
      <td>${
        p.image
          ? `<img src="${p.image}" style="width:50px;height:50px;object-fit:cover;">`
          : "No image"
      }</td>
      <td>${p.name || ""}</td>
      <td>${(p.seller && p.seller.name) || "N/A"}</td>
      <td>${formatCurrency(p.price)}</td>
      <td>${p.category || "N/A"}</td>
      <td>${p.brand || "N/A"}</td>
      <td>${p.description || "No description"}</td>
      <td>${p.quantity || 0}</td>
      <td>${actionsForProduct(p, type)}</td>
    </tr>`
            )
            .join("") +
          "</tbody></table></div>"
        );
      }

      function actionsForProduct(p, type) {
        if (type === "pending")
          return (
            formBtn(p._id, "approve", "Approve") +
            formBtn(p._id, "reject", "Reject")
          );
        if (type === "approved") return formBtn(p._id, "reject", "Reject");
        if (type === "rejected") return formBtn(p._id, "approve", "Approve");
        return "";
      }
      function formBtn(id, action, label) {
        const cls =
          action === "approve" ? "btn btn-approve" : "btn btn-suspend";
        return `<form method="POST" action="/manager/products/${id}/${action}?from=static" style="display:inline;"><button type="submit" class="${cls}">${label}</button></form>`;
      }

      function renderProductTables(data) {
        document.getElementById("pending").innerHTML = tableRows(
          data.pendingProducts,
          "pending"
        );
        document.getElementById("approved").innerHTML = tableRows(
          data.approvedProducts,
          "approved"
        );
        document.getElementById("rejected").innerHTML = tableRows(
          data.rejectedProducts,
          "rejected"
        );
      }

      function setupTabs() {
        const btns = document.querySelectorAll(".tab-btn");
        btns.forEach((btn) =>
          btn.addEventListener("click", () => {
            btns.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            ["pending", "approved", "rejected"].forEach((id) => {
              document.getElementById(id).style.display =
                id === btn.dataset.tab ? "block" : "none";
            });
          })
        );
      }

      function highlightActiveNav() {
        const links = document.querySelectorAll(".navbar nav a");
        const path = window.location.pathname;
        links.forEach((a) => {
          const href = a.getAttribute("href");
          if (href === path) a.classList.add("active");
        });
      }

      function drawCharts(userCounts) {
        if (!Array.isArray(userCounts)) return;
        new Chart(document.getElementById("userDistributionChart"), {
          type: "pie",
          data: {
            labels: ["Customers", "Service Providers", "Sellers", "Manager"],
            datasets: [
              {
                data: userCounts,
                backgroundColor: ["#4299e1", "#48bb78", "#ed8936", "#9f7aea"],
              },
            ],
          },
          options: { plugins: { legend: { position: "bottom" } } },
        });
        new Chart(document.getElementById("revenueChart"), {
          type: "bar",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [
              {
                label: "Total Revenue",
                data: [8500, 9200, 7800, 10500, 11200, 9800],
                backgroundColor: "#4299e1",
                borderRadius: 5,
              },
              {
                label: "Commission (20%)",
                data: [1700, 1840, 1560, 2100, 2240, 1960],
                backgroundColor: "#48bb78",
                borderRadius: 5,
              },
            ],
          },
        });
        new Chart(document.getElementById("userGrowthChart"), {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [
              {
                label: "Total Users",
                data: [850, 950, 1050, 1150, 1200, 1234],
                borderColor: "#4299e1",
                tension: 0.3,
                fill: false,
              },
              {
                label: "Service Providers",
                data: [200, 230, 260, 290, 320, 340],
                borderColor: "#48bb78",
                tension: 0.3,
                fill: false,
              },
              {
                label: "Sellers",
                data: [100, 120, 150, 180, 210, 230],
                borderColor: "#ed8936",
                tension: 0.3,
                fill: false,
              },
            ],
          },
        });
      }

      injectNav();
      highlightActiveNav();
      loadDashboard();
    </script>
  </body>
</html>
