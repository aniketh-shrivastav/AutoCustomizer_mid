<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profiles - Admin</title>
    <link rel="stylesheet" href="/styles/admin-consistent.css" />
    <style>
      .profiles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .profile-card {
        background: var(--card-background);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }
      .profile-card:hover {
        transform: translateY(-5px);
      }
      .profile-header {
        background: var(--primary-color);
        padding: 15px;
        text-align: center;
      }
      .profile-body {
        padding: 15px;
        color: #333;
      }
      .profile-name {
        font-size: 18px;
        font-weight: bold;
        margin: 0 0 5px;
        text-align: center;
      }
      .profile-info p {
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
      }
      .profile-actions {
        display: flex;
        justify-content: center;
        margin-top: 10px;
      }
      .seller-badge,
      .service-provider-badge {
        color: #fff;
        padding: 5px 10px;
        font-weight: bold;
        border-radius: 5px;
        margin-top: 10px;
        text-align: center;
      }
      .seller-badge {
        background: #ff5733;
      }
      .service-provider-badge {
        background: #3498db;
      }
      .customer-badge {
        background: #2ecc71;
        color: #fff;
        padding: 5px 10px;
        font-weight: bold;
        border-radius: 5px;
        margin-top: 10px;
        text-align: center;
      }
      .tab-bar {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .tab-button {
        padding: 10px 20px;
        border: none;
        background: var(--primary-color);
        color: #fff;
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .tab-button:hover {
        background: #444;
      }
      .tab-button.active {
        background: #27ae60;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background: #fff;
        margin: 6% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .close-modal {
        float: right;
        font-size: 24px;
        cursor: pointer;
      }
      #error {
        color: #e74c3c;
        font-weight: bold;
        margin-top: 15px;
      }
      #loading {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <header class="navbar">
      <div class="logo"><h2>Manager's Panel</h2></div>
      <nav>
        <ul>
          <li><a href="/manager/dashboard.html">Dashboard</a></li>
          <li><a href="/manager/users.html">User Management</a></li>
          <li>
            <a class="active" href="/manager/services.html">User Profiles</a>
          </li>
          <li><a href="/manager/orders.html">Orders & Bookings</a></li>
          <li><a href="/manager/payments.html">Payments</a></li>
          <li><a href="/manager/support.html">Support</a></li>
          <li><a href="/logout">Logout</a></li>
        </ul>
      </nav>
    </header>

    <div class="main-content">
      <h1>User Profiles</h1>
      <div class="tab-bar">
        <button class="tab-button active" data-role="all">All Profiles</button>
        <button class="tab-button" data-role="customer">Customer</button>
        <button class="tab-button" data-role="seller">Seller</button>
        <button class="tab-button" data-role="service-provider">
          Service Provider
        </button>
      </div>
      <div class="search-bar" style="margin-top: 15px">
        <input type="text" id="searchInput" placeholder="Search profiles..." />
      </div>
      <div id="error" style="display: none"></div>
      <div id="loading">Loading profiles...</div>
      <div
        class="profiles-grid"
        id="profilesContainer"
        style="display: none"
      ></div>
    </div>

    <div id="profileModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="modalBody"></div>
      </div>
    </div>

    <script>
      let currentRole = "all";
      async function fetchProfiles() {
        const resp = await fetch("/manager/api/services", {
          headers: { Accept: "application/json" },
        });
        if (resp.status === 401 || resp.status === 403) {
          window.location.href = "/login";
          return null;
        }
        if (!resp.ok) throw new Error("Failed to load profiles");
        return resp.json();
      }

      function profileCard(type, data) {
        const isEmpty = (val) =>
          val === undefined || val === null || val === "";
        const blankIfEmpty = (val) => (isEmpty(val) ? "" : val);
        const needsUpdateFlags = [];

        if (type === "service-provider") {
          const servicesArr = Array.isArray(data.servicesOffered)
            ? data.servicesOffered
            : [];
          if (!servicesArr.length) needsUpdateFlags.push("services");
          const services = servicesArr.length
            ? servicesArr
                .map(
                  (s) =>
                    `<li><strong>${blankIfEmpty(s.name)}</strong>${
                      !isEmpty(s.cost) ? ` - â‚¹${s.cost}` : ""
                    }</li>`
                )
                .join("")
            : "<li>No services listed</li>";
          if (isEmpty(data.district)) needsUpdateFlags.push("district");
          const profileNotice = needsUpdateFlags.length
            ? `<div style="margin-top:8px;font-size:12px;color:#b45309;font-weight:600;">Profile not updated</div>`
            : "";
          return `<div class="profile-card service-provider" data-role="service-provider" data-name="${blankIfEmpty(
            data.name
          ).toLowerCase()}" data-email="${blankIfEmpty(
            data.email
          ).toLowerCase()}">
            <div class="profile-header"></div>
            <div class="profile-body">
              <h3 class="profile-name">${blankIfEmpty(data.name)}</h3>
              <div class="profile-info">
                <p><strong>Email:</strong> <span>${blankIfEmpty(
                  data.email
                )}</span></p>
                <p><strong>Phone:</strong> <span>${blankIfEmpty(
                  data.phone
                )}</span></p>
              </div>
              <h3>Services Offered:</h3>
              <ul>${services}</ul>
              <p><strong>District:</strong> ${blankIfEmpty(data.district)}</p>
              <div class="service-provider-badge">Service Provider</div>
              ${profileNotice}
              <div class="profile-actions"><button class="btn-view" data-view-id="${
                data._id
              }">View Profile</button></div>
            </div></div>`;
        }
        if (type === "seller") {
          const user = data.sellerId || {};
          if (isEmpty(data.ownerName) || isEmpty(data.address))
            needsUpdateFlags.push("sellerDetails");
          const profileNotice = needsUpdateFlags.length
            ? `<div style="margin-top:8px;font-size:12px;color:#b45309;font-weight:600;">Profile not updated</div>`
            : "";
          return `<div class="profile-card seller" data-role="seller" data-name="${blankIfEmpty(
            user.name
          ).toLowerCase()}" data-email="${blankIfEmpty(
            user.email
          ).toLowerCase()}">
            <div class="profile-header"></div>
            <div class="profile-body">
              <h3 class="profile-name">${blankIfEmpty(user.name)}</h3>
              <div class="profile-info">
                <p><strong>Contact Email:</strong> <span>${blankIfEmpty(
                  user.email
                )}</span></p>
                <p><strong>Phone:</strong> <span>${blankIfEmpty(
                  user.phone
                )}</span></p>
              </div>
              <h3>Store Details:</h3>
              <p><strong>Owner Name:</strong> ${blankIfEmpty(
                data.ownerName
              )}</p>
              <p><strong>Store Address:</strong> ${blankIfEmpty(
                data.address
              )}</p>
              <div class="seller-badge">Seller</div>
              ${profileNotice}
              <div class="profile-actions"><button class="btn-view" data-view-id="${
                data._id
              }">View Profile</button></div>
            </div></div>`;
        }
        if (type === "customer") {
          const user = data.userId || {};
          if (
            isEmpty(data.address) ||
            isEmpty(data.district) ||
            isEmpty(data.carModel)
          )
            needsUpdateFlags.push("customerDetails");
          const profileNotice = needsUpdateFlags.length
            ? `<div style="margin-top:8px;font-size:12px;color:#b45309;font-weight:600;">Profile not updated</div>`
            : "";
          return `<div class="profile-card customer" data-role="customer" data-name="${blankIfEmpty(
            user.name
          ).toLowerCase()}" data-email="${blankIfEmpty(
            user.email
          ).toLowerCase()}">
            <div class="profile-header"></div>
            <div class="profile-body">
              <h3 class="profile-name">${blankIfEmpty(user.name)}</h3>
              <div class="profile-info">
                <p><strong>Email:</strong> <span>${blankIfEmpty(
                  user.email
                )}</span></p>
                <p><strong>Phone:</strong> <span>${blankIfEmpty(
                  user.phone
                )}</span></p>
              </div>
              <h3>Customer Details:</h3>
              <p><strong>Address:</strong> ${blankIfEmpty(data.address)}</p>
              <p><strong>District:</strong> ${blankIfEmpty(data.district)}</p>
              <p><strong>Car Model:</strong> ${blankIfEmpty(data.carModel)}</p>
              <p><strong>Payments:</strong> ${blankIfEmpty(data.payments)}</p>
              <div class="customer-badge">Customer</div>
              ${profileNotice}
              <div class="profile-actions"><button class="btn-view" data-view-id="${
                data._id
              }">View Profile</button></div>
            </div></div>`;
        }
        return "";
      }

      function renderProfiles(data) {
        const container = document.getElementById("profilesContainer");
        const cards = [];
        data.serviceProviders.forEach((sp) =>
          cards.push(profileCard("service-provider", sp))
        );
        data.sellers.forEach((se) => cards.push(profileCard("seller", se)));
        data.customers.forEach((cu) => cards.push(profileCard("customer", cu)));
        container.innerHTML = cards.join("");
      }

      function filterByRole(role) {
        document
          .querySelectorAll(".tab-button")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelector(`.tab-button[data-role="${role}"]`)
          .classList.add("active");
        currentRole = role;
        // Re-apply search so both filters combine
        applySearch();
      }

      function applySearch() {
        const term = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();
        document.querySelectorAll(".profile-card").forEach((card) => {
          const matchesRole =
            currentRole === "all" || card.classList.contains(currentRole);
          const name = card.getAttribute("data-name") || "";
          const email = card.getAttribute("data-email") || "";
          const matchesText =
            !term || name.includes(term) || email.includes(term);
          card.style.display = matchesRole && matchesText ? "block" : "none";
        });
      }

      async function loadProfiles() {
        try {
          const data = await fetchProfiles();
          if (!data) return;
          document.getElementById("loading").style.display = "none";
          document.getElementById("profilesContainer").style.display = "grid";
          renderProfiles(data);
          filterByRole("all");
        } catch (err) {
          document.getElementById("loading").style.display = "none";
          showError(err.message || "Failed to load profiles");
        }
      }

      function showError(msg) {
        const e = document.getElementById("error");
        e.textContent = msg;
        e.style.display = "block";
      }

      // Modal logic (reuse existing profile-data endpoint)
      document.addEventListener("click", async (e) => {
        const btn = e.target.closest(".btn-view");
        if (!btn) return;
        const id = btn.getAttribute("data-view-id");
        try {
          const resp = await fetch(`/manager/profile-data/${id}`);
          if (resp.status === 401 || resp.status === 403) {
            window.location.href = "/login";
            return;
          }
          const data = await resp.json();
          const modalBody = document.getElementById("modalBody");
          modalBody.innerHTML = `\n          <h2>${
            data.role
          } Profile</h2>\n          <p><strong>Name:</strong> ${
            data.name || ""
          }</p>\n          <p><strong>Email:</strong> ${
            data.email || ""
          }</p>\n          <p><strong>Phone:</strong> ${
            data.phone || ""
          }</p>\n          ${data.extraDetails || ""}\n        `;
          document.getElementById("profileModal").style.display = "block";
        } catch (err) {
          alert("Error loading profile.");
        }
      });

      document.querySelector(".close-modal").addEventListener("click", () => {
        document.getElementById("profileModal").style.display = "none";
      });
      window.addEventListener("click", (e) => {
        if (e.target === document.getElementById("profileModal")) {
          document.getElementById("profileModal").style.display = "none";
        }
      });

      document
        .getElementById("searchInput")
        .addEventListener("input", applySearch);
      document
        .querySelectorAll(".tab-button")
        .forEach((btn) =>
          btn.addEventListener("click", () => filterByRole(btn.dataset.role))
        );

      function highlightActiveNav() {
        const links = document.querySelectorAll(".navbar nav a");
        const path = window.location.pathname;
        links.forEach((a) => {
          const href = a.getAttribute("href");
          if (href === path) a.classList.add("active");
        });
      }

      highlightActiveNav();
      loadProfiles();
    </script>
  </body>
</html>
