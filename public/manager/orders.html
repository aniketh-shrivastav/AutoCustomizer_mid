<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Order & Booking Oversight</title>
    <link rel="stylesheet" href="/styles/admin-consistent.css" />
    <style>
      .tab-active {
        background-color: #007bff;
        color: #fff;
      }
      .hidden {
        display: none;
      }
      #loading {
        margin-top: 1rem;
      }
      #error {
        color: #b91c1c;
        font-weight: 600;
        margin: 1rem 0;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <div class="logo"><h2>Manager's Panel</h2></div>
      <nav>
        <ul>
          <li><a href="/manager/dashboard.html">Dashboard</a></li>
          <li><a href="/manager/users.html">User Management</a></li>
          <li><a href="/manager/services.html">User Profiles</a></li>
          <li>
            <a class="active" href="/manager/orders.html">Orders & Bookings</a>
          </li>
          <li><a href="/manager/payments.html">Payments</a></li>
          <li><a href="/manager/support.html">Support</a></li>
          <li><a href="/logout">Logout</a></li>
        </ul>
      </nav>
    </div>
    <div class="main-content">
      <h1>Order & Booking Oversight</h1>
      <div style="margin-bottom: 1rem">
        <button class="tab-btn tab-active" data-tab="orders">Orders</button>
        <button class="tab-btn" data-tab="services">Services Booked</button>
      </div>
      <div id="error" style="display: none"></div>
      <div id="loading">Loading data...</div>

      <div id="ordersTab" class="tab-panel">
        <div class="table-responsive">
          <table class="order-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Seller</th>
                <th>Customer</th>
                <th>Products</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </div>
      </div>

      <div id="servicesTab" class="tab-panel hidden">
        <div class="table-responsive">
          <table class="order-table">
            <thead>
              <tr>
                <th>Service ID</th>
                <th>Service Type</th>
                <th>Description</th>
                <th>Customer</th>
                <th>Provider</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="servicesBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      async function fetchOrders() {
        const resp = await fetch("/manager/api/orders", {
          headers: { Accept: "application/json" },
        });
        if (resp.status === 401 || resp.status === 403) {
          window.location.href = "/login";
          return null;
        }
        if (!resp.ok) throw new Error("Failed to load orders");
        return resp.json();
      }

      function orderRow(order, item) {
        const seller = item.seller || {};
        const user = order.userId || {};
        const statusBadge =
          order.orderStatus === "cancelled"
            ? '<span class="badge badge-danger">Cancelled</span>'
            : '<span class="badge badge-success">Active</span>';
        const actionBtn =
          order.orderStatus === "cancelled"
            ? `<button class="btn btn-restore" data-type="order" data-action="restore" data-id="${order._id}">Restore</button>`
            : `<button class="btn btn-suspend" data-type="order" data-action="cancel" data-id="${order._id}">Cancel</button>`;
        return `<tr data-order-id="${order._id}"><td>${order._id}</td><td>${
          seller.name || ""
        } (${seller.email || ""})</td><td>${user.name || ""} (${
          user.email || ""
        })</td><td><ul><li><strong>${item.name || ""}</strong> (x${
          item.quantity || 0
        })</li></ul></td><td>${statusBadge}</td><td>${actionBtn}</td></tr>`;
      }

      function bookingRow(b) {
        const customer = b.customerId || {};
        const provider = b.providerId || {};
        const statusBadge =
          b.status === "Rejected"
            ? '<span class="badge badge-danger">Rejected</span>'
            : '<span class="badge badge-success">Active</span>';
        const actionBtn =
          b.status === "Rejected"
            ? `<button class="btn btn-restore" data-type="booking" data-action="restore" data-id="${b._id}">Restore</button>`
            : `<button class="btn btn-suspend" data-type="booking" data-action="cancel" data-id="${b._id}">Cancel</button>`;
        return `<tr data-booking-id="${b._id}"><td>${b._id}</td><td>${(
          b.selectedServices || []
        ).join(", ")}</td><td>${b.description || ""}</td><td>${
          customer.name || ""
        } (${customer.email || ""})</td><td>${provider.name || ""} (${
          provider.email || ""
        })</td><td>${statusBadge}</td><td>${actionBtn}</td></tr>`;
      }

      function renderOrders(data) {
        const oBody = document.getElementById("ordersBody");
        const sBody = document.getElementById("servicesBody");
        oBody.innerHTML = "";
        sBody.innerHTML = "";
        data.orders.forEach((order) => {
          (order.items || []).forEach((it) => {
            oBody.insertAdjacentHTML("beforeend", orderRow(order, it));
          });
        });
        data.bookings.forEach((b) => {
          sBody.insertAdjacentHTML("beforeend", bookingRow(b));
        });
      }

      function switchTab(tab) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("tab-active"));
        const activeBtn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
        if (activeBtn) activeBtn.classList.add("tab-active");
        const ordersEl = document.getElementById("ordersTab");
        const servicesEl = document.getElementById("servicesTab");
        if (tab === "orders") {
          ordersEl.classList.remove("hidden");
          servicesEl.classList.add("hidden");
        } else {
          servicesEl.classList.remove("hidden");
          ordersEl.classList.add("hidden");
        }
      }

      async function performAction(el) {
        const id = el.getAttribute("data-id");
        const type = el.getAttribute("data-type");
        const action = el.getAttribute("data-action");
        const confirmMsg =
          action === "cancel"
            ? "Cancel this " + type + "?"
            : "Restore this " + type + "?";
        if (!confirm(confirmMsg)) return;
        const endpoint =
          type === "order"
            ? `/manager/${
                action === "cancel" ? "cancel-order" : "restore-order"
              }/${id}`
            : `/manager/${
                action === "cancel" ? "cancel-booking" : "restore-booking"
              }/${id}`;
        const resp = await fetch(endpoint, {
          method: "POST",
          headers: { Accept: "application/json" },
        });
        if (resp.status === 401 || resp.status === 403) {
          window.location.href = "/login";
          return;
        }
        const data = await resp.json();
        if (!resp.ok || !data.success) {
          alert(data.message || "Action failed");
          return;
        }
        // Update UI: re-fetch simpler for correctness
        init();
      }

      document.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (btn) performAction(btn);
        const tabBtn = e.target.closest(".tab-btn");
        if (tabBtn) switchTab(tabBtn.getAttribute("data-tab"));
      });

      async function init() {
        try {
          const data = await fetchOrders();
          if (!data) return;
          document.getElementById("loading").style.display = "none";
          // panels controlled by hidden class; ensure initial state
          document.getElementById("ordersTab").classList.remove("hidden");
          document.getElementById("servicesTab").classList.add("hidden");
          renderOrders(data);
          switchTab("orders");
        } catch (err) {
          document.getElementById("loading").style.display = "none";
          const errEl = document.getElementById("error");
          errEl.textContent = err.message || "Failed to load";
          errEl.style.display = "block";
        }
      }

      function highlightActiveNav() {
        const links = document.querySelectorAll(".navbar nav a");
        const path = window.location.pathname;
        links.forEach((a) => {
          const href = a.getAttribute("href");
          if (href === path) a.classList.add("active");
        });
      }

      highlightActiveNav();
      init();
    </script>
  </body>
</html>
