<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Order Management</title>
    <link rel="stylesheet" href="/styles/bookingManagement.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="logo-brand">
        <img src="/public/images3/logo2.jpg" alt="Logo" class="logo" />
        <span class="brand">AutoCustomizer</span>
      </div>
      <a href="#" class="menu-btn" onclick="toggleSidebar()">â˜°</a>
      <div class="nav-links" id="navLinks">
        <a href="/service/dashboardService.html">Dashboard</a>
        <a href="/service/profileSettings.html">Profile Settings</a>
        <a href="/service/bookingManagement.html" class="active"
          >Booking Management</a
        >
        <a href="/service/reviews.html">Reviews & Ratings</a>
        <a href="/logout">Logout</a>
      </div>
    </nav>
    <div class="sidebar" id="sidebar">
      <a class="close-btn" onclick="toggleSidebar()">Close Ã—</a>
      <a href="/service/dashboardService.html"
        ><i class="fas fa-tachometer-alt"></i
      ></a>
      <a href="/service/profileSettings.html"
        ><i class="fas fa-user-cog"></i
      ></a>
      <a href="/service/bookingManagement.html" class="active"
        ><i class="fas fa-calendar-alt"></i
      ></a>
      <a href="/service/customerCommunication"
        ><i class="fas fa-comments"></i
      ></a>
      <a href="/service/earnings"><i class="fas fa-money-bill-wave"></i></a>
      <a href="/service/reviews.html"><i class="fas fa-star"></i></a>
    </div>

    <div class="order-container">
      <div
        class="instructions"
        style="
          background: #fff4e5;
          border: 1px solid #ffa500;
          padding: 10px;
          margin-bottom: 15px;
          border-radius: 8px;
        "
      >
        <h3>ğŸ”” Please follow these guidelines before taking any action:</h3>
        <ul style="padding-left: 20px">
          <li>
            ğŸ“Œ <strong>Description must include the vehicle number</strong>. If
            not present, <strong>reject</strong> the order.
          </li>
          <li>
            ğŸ“ <strong>Always call the customer</strong> before confirming,
            rejecting, or changing the price of an order.
          </li>
          <li>
            ğŸ“¦ If the order includes a service <strong>with a product</strong>,
            <strong>wait for the product to arrive</strong> before confirming.
          </li>
          <li>
            ğŸ“ Ensure the
            <strong>customerâ€™s address is within your service range</strong>
            before proceeding.
          </li>
        </ul>
      </div>

      <div class="order-header">
        <button class="tab active">Open</button>
        <button class="tab">Confirmed</button>
        <button class="tab">Ready</button>
        <button class="tab">Rejected</button>
      </div>

      <div class="filter-section">
        <input
          type="text"
          id="searchInput"
          placeholder="Search by Customer ID or Name"
          class="search-input"
        />
        <select class="dropdown">
          <option>Newest Order Sent</option>
          <option>Oldest Order Sent</option>
        </select>
        <button class="filter-btn">Filter</button>
      </div>

      <table class="order-table">
        <thead>
          <tr>
            <th></th>
            <th>Service ID</th>
            <th>Service</th>
            <th>Description</th>
            <th>Car Model</th>
            <th>Customer Name</th>
            <th>Customer email</th>
            <th>Phone Number</th>
            <th>Address</th>
            <th>District</th>
            <th>Status</th>
            <th>Order Sent</th>
            <th>Total Cost</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>

      <div class="action-buttons">
        <button class="confirm-btn">âœ… Confirm</button>
        <button class="reject-btn">âŒ Reject</button>
      </div>
    </div>

    <script>
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
      }

      async function loadBookings() {
        try {
          const res = await fetch("/service/api/bookings", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "Failed to load");
          const tbody = document.getElementById("ordersBody");
          tbody.innerHTML = "";
          data.bookings.forEach((order) => {
            const tr = document.createElement("tr");
            const editableCost = order.status === "Open";
            tr.innerHTML = `
            <td><input type="checkbox" class="order-checkbox" data-order-id="${
              order.id
            }"></td>
            <td>${order.id}</td>
            <td>${order.selectedServices.join(", ")}</td>
            <td>${order.description}</td>
            <td>${order.carModel}</td>
            <td>${order.customerName}</td>
            <td>${order.customerEmail}</td>
            <td>${order.phone}</td>
            <td><span class="address-cell" data-full-address="${order.address}">${order.address}</span></td>
            <td>${order.district}</td>
            <td>${order.status}</td>
            <td>${new Date(order.createdAt).toLocaleDateString()}</td>
            <td>${
              editableCost
                ? `<form data-cost-form="${order.id}"><input type="number" name="totalCost" value="${order.totalCost}" min="0" required style="width:80px;"><button type="submit" style="padding:2px 5px;">ğŸ’¾</button></form>`
                : "â‚¹" + order.totalCost
            }</td>
            <td>${
              order.status === "Confirmed"
                ? `<button class="btn btn-ready" data-order-id="${order.id}">Mark as Ready</button>`
                : "<span>â€”</span>"
            }</td>
          `;
            tbody.appendChild(tr);
          });
          attachRowHandlers();
          initFilterLogic();
        } catch (err) {
          console.error(err);
          alert("Could not load bookings");
        }
      }

      function attachRowHandlers() {
        document.querySelectorAll(".btn-ready").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const orderId = btn.getAttribute("data-order-id");
            await updateBooking(orderId, "Ready");
            loadBookings();
          });
        });
        document.querySelectorAll("form[data-cost-form]").forEach((f) => {
          f.addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = f.getAttribute("data-cost-form");
            const valInput = f.querySelector('input[name="totalCost"]');
            const val = valInput.value;
            const prev = valInput.getAttribute("data-prev");
            try {
              await updateBooking(id, undefined, val);
              valInput.setAttribute("data-prev", val);
              alert("Price saved successfully.");
              loadBookings();
            } catch (err) {
              if (prev) valInput.value = prev; // revert on failure
            }
          });
        });
        
        // Address cell click handler
        document.querySelectorAll(".address-cell").forEach((cell) => {
          cell.addEventListener("click", (e) => {
            e.stopPropagation();
            // Remove active class from all address cells
            document.querySelectorAll(".address-cell").forEach((c) => {
              c.classList.remove("active");
            });
            // Add active class to clicked cell
            cell.classList.add("active");
          });
        });
        
        // Close tooltip when clicking elsewhere
        document.addEventListener("click", () => {
          document.querySelectorAll(".address-cell").forEach((cell) => {
            cell.classList.remove("active");
          });
        }, { capture: false });
        
        document.querySelector(".confirm-btn").onclick = () =>
          bulkUpdate("Confirmed");
        document.querySelector(".reject-btn").onclick = () =>
          bulkUpdate("Rejected");
      }

      async function updateBooking(orderId, status, totalCost) {
        try {
          const body = { orderId };
          if (status) body.status = status;
          if (typeof totalCost !== "undefined") body.totalCost = totalCost;
          const res = await fetch("/service/updateBooking", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          if (!res.ok) throw new Error("Update failed");
        } catch (err) {
          console.error(err);
          alert("Error updating booking");
        }
      }

      async function bulkUpdate(newStatus) {
        const selected = Array.from(
          document.querySelectorAll(".order-checkbox:checked")
        ).map((cb) => cb.getAttribute("data-order-id"));
        if (!selected.length) {
          alert("Please select at least one order.");
          return;
        }
        const res = await fetch("/service/updateMultipleBookingStatus", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderIds: selected, newStatus }),
        });
        const out = await res.json();
        if (!out.success) {
          alert("Bulk update failed");
          return;
        }
        loadBookings();
      }

      function initFilterLogic() {
        const tabs = document.querySelectorAll(".tab");
        const filterDropdown = document.querySelector(".dropdown");
        const filterBtn = document.querySelector(".filter-btn");
        const searchInput = document.getElementById("searchInput");
        const actionButtons = document.querySelector(".action-buttons");

        function getStatusFromTab(t) {
          return t;
        }
        function filterTable() {
          const activeTab = document
            .querySelector(".tab.active")
            .textContent.trim();
          const statusFilter = getStatusFromTab(activeTab);
          const searchTerm = searchInput.value.trim().toLowerCase();
          const sortOrder = filterDropdown.value;
          const rows = Array.from(document.querySelectorAll("#ordersBody tr"));
          rows.forEach((row) => {
            const status = row.cells[10]?.textContent.trim();
            const customerName = row.cells[5]?.textContent.toLowerCase();
            const customerEmail = row.cells[6]?.textContent.toLowerCase();
            const matchesStatus = status === statusFilter;
            const matchesSearch =
              !searchTerm ||
              customerName.includes(searchTerm) ||
              customerEmail.includes(searchTerm);
            row.style.display = matchesStatus && matchesSearch ? "" : "none";
          });
          const tbody = document.getElementById("ordersBody");
          const sorted = rows.sort((a, b) => {
            const dateA = new Date(a.cells[11].textContent.trim());
            const dateB = new Date(b.cells[11].textContent.trim());
            return sortOrder === "Newest Order Sent"
              ? dateB - dateA
              : dateA - dateB;
          });
          sorted.forEach((r) => tbody.appendChild(r));
          actionButtons.style.display = activeTab === "Open" ? "flex" : "none";
        }
        tabs.forEach((tab) =>
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            filterTable();
          })
        );
        filterBtn.addEventListener("click", filterTable);
        searchInput.addEventListener("input", filterTable);
        filterTable();
      }

      document.addEventListener("DOMContentLoaded", loadBookings);
    </script>
  </body>
</html>
