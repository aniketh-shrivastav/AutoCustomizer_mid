<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Reviews & Ratings</title>
    <link rel="stylesheet" href="/styles/reviews.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="logo-brand">
        <img src="/public/images3/logo2.jpg" alt="Logo" class="logo" />
        <span class="brand">AutoCustomizer</span>
      </div>
      <a href="#" class="menu-btn" onclick="toggleSidebar()">☰</a>
      <div class="nav-links" id="navLinks">
        <a href="/service/dashboardService.html">Dashboard</a>
        <a href="/service/profileSettings.html">Profile Settings</a>
        <a href="/service/bookingManagement.html">Booking Management</a>
        <a href="/service/reviews.html" class="active">Reviews & Ratings</a>
        <a href="/logout">Logout</a>
      </div>
    </nav>

    <div class="sidebar" id="sidebar">
      <a class="close-btn" onclick="toggleSidebar()">Close ×</a>
      <a href="/service/dashboardService.html"
        ><i class="fas fa-tachometer-alt"></i
      ></a>
      <a href="/service/profileSettings.html"
        ><i class="fas fa-user-cog"></i
      ></a>
      <a href="/service/bookingManagement.html"
        ><i class="fas fa-calendar-alt"></i
      ></a>
      <a href="/service/customerCommunication"
        ><i class="fas fa-comments"></i
      ></a>
      <a href="/service/earnings"><i class="fas fa-money-bill-wave"></i></a>
      <a href="/service/reviews.html" class="active"
        ><i class="fas fa-star"></i
      ></a>
    </div>

    <div class="container">
      <h1>Reviews & Ratings</h1>
      <div class="reviews-container" id="reviewsContainer">
        <!-- Dynamic reviews will be injected here -->
      </div>
    </div>

    <script>
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
      }

      function createStarIcons(rating) {
        const container = document.createElement("div");
        container.className = "rating";
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        for (let i = 0; i < fullStars; i++) {
          const iEl = document.createElement("i");
          iEl.className = "fas fa-star";
          container.appendChild(iEl);
        }
        if (halfStar) {
          const iEl = document.createElement("i");
          iEl.className = "fas fa-star-half-alt";
          container.appendChild(iEl);
        }
        for (let i = fullStars + (halfStar ? 1 : 0); i < 5; i++) {
          const iEl = document.createElement("i");
          iEl.className = "far fa-star";
          container.appendChild(iEl);
        }
        const span = document.createElement("span");
        span.className = "rating-value";
        span.textContent = Number(rating).toFixed(1);
        container.appendChild(span);
        return container;
      }

      async function loadReviews() {
        try {
          const res = await fetch("/service/api/reviews", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          const data = await res.json();
          if (!data.success)
            throw new Error(data.message || "Failed to load reviews");
          const wrap = document.getElementById("reviewsContainer");
          wrap.innerHTML = "";
          if (!data.reviews.length) {
            wrap.innerHTML =
              '<p style="text-align:center;color:#555;">No reviews yet.</p>';
            return;
          }
          data.reviews.forEach((r) => {
            const card = document.createElement("div");
            card.className = "review-card";
            card.innerHTML = `
              <div class="review-header">
                <div class="user-info">
                  <span class="user-name">${r.customerName}</span>
                </div>
              </div>
              <p class="review-text">"${r.reviewText}"</p>
              <span class="review-date">${new Date(
                r.createdAt
              ).toLocaleDateString()}</span>
            `;
            // Insert stars after the user-name block
            const header = card.querySelector(".user-info");
            header.appendChild(createStarIcons(r.rating));
            wrap.appendChild(card);
          });
        } catch (err) {
          console.error(err);
          alert("Could not load reviews");
        }
      }

      document.addEventListener("DOMContentLoaded", loadReviews);
    </script>
  </body>
</html>
