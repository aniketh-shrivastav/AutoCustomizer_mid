<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Service Provider Dashboard</title>
    <link rel="stylesheet" href="/styles/dashboardService.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="logo-brand">
        <img src="/public/images3/logo2.jpg" alt="Logo" class="logo" />
        <span class="brand">AutoCustomizer</span>
      </div>
      <a href="#" class="menu-btn" onclick="toggleSidebar()">☰</a>
      <div class="nav-links" id="navLinks">
        <a href="/service/dashboardService.html" class="active">Dashboard</a>
        <a href="/service/profileSettings.html">Profile Settings</a>
        <a href="/service/bookingManagement">Booking Management</a>
        <a href="/service/reviews.html">Reviews & Ratings</a>
        <a href="/logout">Logout</a>
      </div>
    </nav>

    <div class="sidebar" id="sidebar">
      <a class="close-btn" onclick="toggleSidebar()">Close ×</a>
      <a href="/service/dashboardService.html"
        ><i class="fas fa-tachometer-alt"></i> Dashboard</a
      >
      <a href="/service/profileSettings.html"
        ><i class="fas fa-user-cog"></i> Profile Settings</a
      >
      <a href="/service/bookingManagement"
        ><i class="fas fa-calendar-alt"></i> Bookings</a
      >
      <a href="/service/customerCommunication"
        ><i class="fas fa-comments"></i> Communication</a
      >
      <a href="/service/earnings"
        ><i class="fas fa-money-bill-wave"></i> Earnings</a
      >
      <a href="/service/reviews.html"><i class="fas fa-star"></i> Reviews</a>
      <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="dashboard-container">
      <div class="dashboard-header">
        <h2>Welcome! Here's your daily overview.</h2>
      </div>
      <div class="cards" id="metricCards">
        <div class="card">
          <div class="card-icon"><i class="fas fa-rupee-sign"></i></div>
          <div class="card-content">
            <h2>Total Earnings</h2>
            <p class="amount" id="earningsValue">₹0</p>
            <p class="subtext">After 20% commission</p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon"><i class="fas fa-tools"></i></div>
          <div class="card-content">
            <h2>Confirmed Services</h2>
            <p class="amount" id="ongoingValue">0</p>
            <p class="subtext">Currently active</p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon"><i class="fas fa-check-circle"></i></div>
          <div class="card-content">
            <h2>Ready for Delivery</h2>
            <p class="amount" id="completedValue">0</p>
            <p class="subtext">Total completed</p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon"><i class="fas fa-smile"></i></div>
          <div class="card-content">
            <h2>Customer Satisfaction</h2>
            <p class="amount" id="ratingValue">N/A/5</p>
            <p class="subtext" id="reviewsValue">Based on 0 reviews</p>
          </div>
        </div>
      </div>

      <div class="charts">
        <div class="chart-card chart-wrapper">
          <h2>Service Distribution</h2>
          <canvas id="servicePieChart"></canvas>
        </div>
        <div class="chart-card">
          <h2>Monthly Earnings Overview (Weekly Basis)</h2>
          <div class="chart-wrapper" style="height: 300px">
            <canvas id="earningsBarChart"></canvas>
          </div>
        </div>
      </div>

      <div class="recent-activity">
        <h2>Recent Activity</h2>
        <ul class="activity-list" id="activityList">
          <li>
            <i class="fas fa-info-circle"></i
            ><span>Loading recent activity...</span>
          </li>
        </ul>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      let earningsBarChart; // Store chart instance for updates
      
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
      }
      function toggleNavLinks() {
        document.getElementById("navLinks").classList.toggle("active");
      }

      // Fetch real earnings data from API
      async function fetchEarningsData() {
        try {
          const res = await fetch("/service/api/earnings-data?timeRange=1");
          if (!res.ok) throw new Error("Failed to fetch earnings data");
          const data = await res.json();
          return {
            labels: data.labels,
            data: data.data,
            totalEarnings: data.totalEarnings
          };
        } catch (error) {
          console.error("Error fetching earnings data:", error);
          return { labels: [], data: [], totalEarnings: 0 };
        }
      }

      // Fetch recent activity from API
      async function fetchRecentActivity() {
        try {
          const res = await fetch("/service/api/recent-activity?limit=5");
          if (!res.ok) throw new Error("Failed to fetch recent activity");
          const data = await res.json();
          return data.activities || [];
        } catch (error) {
          console.error("Error fetching recent activity:", error);
          return [];
        }
      }

      // Update earnings bar chart with real data
      async function updateEarningsChart() {
        const earningsData = await fetchEarningsData();
        
        if (earningsBarChart && earningsData.labels.length > 0) {
          earningsBarChart.data.labels = earningsData.labels;
          earningsBarChart.data.datasets[0].data = earningsData.data;
          earningsBarChart.update();
        }
      }

      // Update recent activity section
      async function updateRecentActivity() {
        const activities = await fetchRecentActivity();
        const activityList = document.getElementById("activityList");
        
        if (activities.length > 0) {
          activityList.innerHTML = "";
          activities.forEach((activity) => {
            const li = document.createElement("li");
            li.innerHTML = `<i class="fas ${activity.icon}"></i><span>${activity.text}</span><span class="time">${activity.timeAgo}</span>`;
            activityList.appendChild(li);
          });
        }
      }

      // Set up Socket.IO for real-time updates
      let socket = null;
      function initializeSocketIO() {
        if (typeof io !== 'undefined') {
          socket = io();
          
          socket.on('connect', () => {
            console.log('Connected to real-time server');
            // Join earnings room
            socket.emit('earnings:join', { providerId: getProviderId() });
          });
          
          // Listen for earnings updates
          socket.on('earnings:updated', (data) => {
            console.log('Earnings updated in real-time:', data);
            // Refresh chart, activity, and dashboard immediately
            updateEarningsChart();
            updateRecentActivity();
            loadDashboard();
          });
          
          // Listen for activity updates
          socket.on('activity:updated', (data) => {
            console.log('Activity updated in real-time:', data);
            // Refresh activity feed
            updateRecentActivity();
          });
          
          socket.on('disconnect', () => {
            console.log('Disconnected from real-time server');
          });
        }
      }

      // Extract provider ID from session or DOM
      function getProviderId() {
        // Try to get from data attribute
        const elem = document.querySelector('[data-provider-id]');
        if (elem) return elem.getAttribute('data-provider-id');
        return null;
      }

      // Set up periodic refresh every 30 seconds
      function setupAutoRefresh() {
        setInterval(() => {
          updateEarningsChart();
          updateRecentActivity();
        }, 30000);
      }

      async function loadDashboard() {
        try {
          const res = await fetch("/service/api/dashboard", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          if (!res.ok) throw new Error("Failed to fetch dashboard");
          const data = await res.json();
          const { serviceLabels, serviceCounts, totals } = data;
          document.getElementById("earningsValue").textContent =
            "₹" + (totals.earnings || 0);
          document.getElementById("ongoingValue").textContent =
            totals.ongoing || 0;
          document.getElementById("completedValue").textContent =
            totals.completed || 0;
          document.getElementById("ratingValue").textContent =
            (totals.avgRating || "N/A") + "/5";
          document.getElementById("reviewsValue").textContent =
            "Based on " + (totals.totalReviews || 0) + " reviews";

          // Pie chart
          const pieCtx = document
            .getElementById("servicePieChart")
            .getContext("2d");
          new Chart(pieCtx, {
            type: "pie",
            data: {
              labels: serviceLabels,
              datasets: [
                {
                  data: serviceCounts,
                  backgroundColor: [
                    "rgba(26,188,156,0.85)",
                    "rgba(52,152,219,0.85)",
                    "rgba(155,89,182,0.85)",
                    "rgba(241,196,15,0.85)",
                    "rgba(231,76,60,0.85)",
                    "rgba(46,204,113,0.85)",
                    "rgba(230,126,34,0.85)",
                  ],
                  hoverOffset: 8,
                  borderColor: 'rgba(15,42,68,0.06)'
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: { 
                legend: { position: "bottom", labels: { color: '#213040' } }
              },
            },
          });

          // Bar chart with real earnings data
          const earningsData = await fetchEarningsData();
          const barCtx = document
            .getElementById("earningsBarChart")
            .getContext("2d");
          
          earningsBarChart = new Chart(barCtx, {
            type: "bar",
            data: {
              labels: earningsData.labels.length > 0 ? earningsData.labels : ["Week 1", "Week 2", "Week 3", "Week 4"],
              datasets: [
                {
                  label: "Earnings (₹)",
                  data: earningsData.data.length > 0 ? earningsData.data : [0, 0, 0, 0],
                  backgroundColor: "rgba(26,188,156,0.75)",
                  borderColor: "rgba(13,139,122,0.45)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Earnings (₹)" },
                  ticks: { color: '#213040' },
                  grid: { color: 'rgba(15,42,68,0.06)' },
                },
                x: { title: { display: true, text: "Weeks" }, ticks: { color: '#213040' }, grid: { color: 'rgba(15,42,68,0.04)' } },
              },
              plugins: {
                title: {
                  display: true,
                  text: "Monthly Earnings Overview (Weekly Basis)",
                  color: '#213040'
                },
              },
            },
          });

          // Load recent activity
          await updateRecentActivity();
        } catch (err) {
          console.error("Dashboard load error", err);
        }
      }
      
      // Initialize everything on page load
      window.addEventListener('DOMContentLoaded', () => {
        loadDashboard();
        setupAutoRefresh();
        initializeSocketIO();
      });
    </script>
  </body>
</html>













