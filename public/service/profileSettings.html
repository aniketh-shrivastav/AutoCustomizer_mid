<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Profile Settings</title>
    <link rel="stylesheet" href="/styles/profileSettings.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      .error-border {
        border: 2px solid red;
      }
      .error {
        color: red;
        display: none;
        font-size: 0.8em;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="logo-brand">
        <img src="/public/images3/logo2.jpg" alt="Logo" class="logo" />
        <span class="brand">AutoCustomizer</span>
      </div>
      <a href="#" class="menu-btn" onclick="toggleSidebar()">☰</a>
      <div class="nav-links" id="navLinks">
        <a href="/service/dashboardService.html">Dashboard</a>
        <a href="/service/profileSettings.html" class="active"
          >Profile Settings</a
        >
        <a href="/service/bookingManagement">Booking Management</a>
        <a href="/service/reviews.html">Reviews & Ratings</a>
        <a href="/logout">Logout</a>
      </div>
    </nav>

    <div class="sidebar" id="sidebar">
      <a class="close-btn" onclick="toggleSidebar()">Close ×</a>
      <a href="/service/dashboardService.html"
        ><i class="fas fa-tachometer-alt"></i> Dashboard</a
      >
      <a href="/service/profileSettings.html"
        ><i class="fas fa-user-cog"></i> Profile Settings</a
      >
      <a href="/service/bookingManagement"
        ><i class="fas fa-calendar-alt"></i> Booking Management</a
      >
      <a href="/service/reviews.html"
        ><i class="fas fa-star"></i> Reviews & Ratings</a
      >
      <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="profile-container">
      <div class="profile-pic-container">
        <img
          src="/public/images3/image5.jpg"
          alt="Profile Picture"
          class="profile-pic"
        />
      </div>
      <h1>Profile Settings</h1>

      <form id="profileForm" onsubmit="event.preventDefault(); saveChanges();">
        <label>Name:</label>
        <input type="text" id="name" disabled />
        <div id="nameError" class="error"></div>
        <label>Email:</label>
        <input type="email" id="email" disabled />
        <div id="emailError" class="error"></div>
        <label>Phone:</label>
        <input type="tel" id="phone" disabled />
        <div id="phoneError" class="error"></div>
        <label>District:</label>
        <input type="text" id="district" disabled />
        <div id="districtError" class="error"></div>

        <div class="services-container">
          <h2>Services Offered</h2>
          <ul class="service-list" id="serviceList"></ul>
          <div class="service-input-container" style="display: none">
            <input
              type="text"
              id="newService"
              placeholder="New Service Name"
              aria-describedby="newServiceErr"
            />
            <div id="newServiceErr" class="error"></div>

            <input
              type="number"
              id="newServiceCost"
              placeholder="Cost"
              inputmode="decimal"
              min="0.01"
              step="0.01"
              aria-describedby="newServiceCostErr"
            />
            <div id="newServiceCostErr" class="error"></div>
            <button
              type="button"
              class="btn add-service-btn"
              onclick="addService()"
              style="display: none"
            >
              Add Service
            </button>
          </div>
        </div>

        <div class="buttons">
          <button type="button" class="btn edit-btn" onclick="enableEdit()">
            Edit
          </button>
          <button
            type="button"
            class="btn save-btn"
            id="saveBtn"
            onclick="saveChanges()"
            style="display: none"
          >
            Save
          </button>
          <button
            type="button"
            class="btn cancel-btn"
            id="cancelBtn"
            onclick="cancelEdit()"
            style="display: none"
          >
            Cancel
          </button>
        </div>
      </form>

      <div class="delete-account-section">
        <h3>Danger Zone</h3>
        <p>
          Once you delete your account, there is no going back. Please be
          certain.
        </p>
        <button id="delete-account-btn" class="delete-btn" disabled>
          Delete My Account
        </button>
      </div>
    </div>

    <script>
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
      }
      function toggleNavLinks() {
        document.getElementById("navLinks").classList.toggle("active");
      }

      let currentUserId = null;
      async function loadProfile() {
        try {
          const res = await fetch("/service/api/profile", {
            headers: { Accept: "application/json" },
          });
          if (res.status === 401) {
            window.location.href = "/login";
            return;
          }
          if (!res.ok) throw new Error("Failed to load profile");
          const data = await res.json();
          if (!data.success)
            throw new Error(data.message || "Profile load failed");
          const u = data.user;
          currentUserId = u.id;
          document.getElementById("name").value = u.name || "";
          document.getElementById("email").value = u.email || "";
          document.getElementById("phone").value = u.phone || "";
          document.getElementById("district").value = u.district || "";
          const list = document.getElementById("serviceList");
          list.innerHTML = "";
          (u.servicesOffered || []).forEach((s) => {
            const li = document.createElement("li");
            li.className = "service-item";
            li.innerHTML = `<input type="text" class="service-name" value="${s.name}" required disabled><input type="number" class="service-cost" value="${s.cost}" required disabled><button class="delete-btn" onclick="removeService(this)" style="display:none">Delete</button>`;
            list.appendChild(li);
          });
          document.getElementById("delete-account-btn").disabled = false;
        } catch (err) {
          console.error(err);
          alert("Could not load profile");
        }
      }

      function validateForm() {
        let isValid = true;

        const name = document.getElementById("name");
        const email = document.getElementById("email");
        const phone = document.getElementById("phone");
        const district = document.getElementById("district");

        // Name validation
        if (!name.value.trim()) {
          document.getElementById("nameError").textContent =
            "Full Name is required";
          name.classList.add("error-border");
          document.getElementById("nameError").style.display = "block";
          isValid = false;
        } else {
          name.classList.remove("error-border");
          document.getElementById("nameError").style.display = "none";
        }

        // Email validation (disabled, so no validation needed)
        email.classList.remove("error-border");
        document.getElementById("emailError").style.display = "none";

        // Phone validation
        if (!phone.value.trim()) {
          document.getElementById("phoneError").textContent =
            "Phone Number is required";
          phone.classList.add("error-border");
          document.getElementById("phoneError").style.display = "block";
          isValid = false;
        } else if (!/^\d{10}$/.test(phone.value.trim())) {
          document.getElementById("phoneError").textContent =
            "Phone number should contain 10 digits";
          phone.classList.add("error-border");
          document.getElementById("phoneError").style.display = "block";
          isValid = false;
        } else {
          phone.classList.remove("error-border");
          document.getElementById("phoneError").style.display = "none";
        }

        // District validation
        if (!district.value.trim()) {
          document.getElementById("districtError").textContent =
            "District is required";
          district.classList.add("error-border");
          document.getElementById("districtError").style.display = "block";
          isValid = false;
        } else {
          district.classList.remove("error-border");
          document.getElementById("districtError").style.display = "none";
        }

        return isValid;
      }

      async function saveChanges() {
        if (!validateForm()) return;

        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const district = document.getElementById("district").value.trim();
        const serviceItems = document.querySelectorAll(".service-item");
        const servicesOffered = Array.from(serviceItems).map((item) => ({
          name: item.querySelector(".service-name").value.trim(),
          cost:
            parseFloat(item.querySelector(".service-cost").value.trim()) || 0,
        }));
        try {
          const res = await fetch("/profile/update", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ name, phone, district, servicesOffered }),
          });
          const out = await res.json();
          if (!out.success) throw new Error(out.message || "Update failed");
          alert("Profile updated successfully!");
          location.reload();
        } catch (err) {
          console.error(err);
          alert(err.message);
        }
      }

      function enableEdit() {
        ["name", "phone", "district"].forEach(
          (id) => (document.getElementById(id).disabled = false)
        );
        document.querySelector(".edit-btn").style.display = "none";
        document.getElementById("saveBtn").style.display = "inline-block";
        document.getElementById("cancelBtn").style.display = "inline-block";
        document.querySelector(".service-input-container").style.display =
          "block";
        document.querySelector(".add-service-btn").style.display =
          "inline-block";
        document
          .querySelectorAll(
            ".service-item .service-name, .service-item .service-cost"
          )
          .forEach((inp) => (inp.disabled = false));
        document
          .querySelectorAll(".service-item .delete-btn")
          .forEach((btn) => (btn.style.display = "inline-block"));
        // Show account delete button only in edit mode
        const accDelBtn = document.getElementById("delete-account-btn");
        if (accDelBtn) accDelBtn.style.display = "inline-block";
        // Initialize new service validation and disable Add until valid
        const nameEl = document.getElementById("newService");
        const costEl = document.getElementById("newServiceCost");
        const addBtn = document.querySelector(".add-service-btn");
        if (addBtn) addBtn.disabled = true;
        if (nameEl) {
          nameEl.addEventListener("input", () =>
            validateNewServiceInputs(true)
          );
          nameEl.addEventListener("blur", () => validateNewServiceInputs(true));
        }
        if (costEl) {
          costEl.addEventListener("input", () =>
            validateNewServiceInputs(true)
          );
          costEl.addEventListener("blur", () => validateNewServiceInputs(true));
        }
      }
      function cancelEdit() {
        // Hide account delete button again
        const accDelBtn = document.getElementById("delete-account-btn");
        if (accDelBtn) accDelBtn.style.display = "none";
        location.reload();
      }
      function validateNewServiceInputs(showMessages = false) {
        const nameEl = document.getElementById("newService");
        const costEl = document.getElementById("newServiceCost");
        const errName = document.getElementById("newServiceErr");
        const errCost = document.getElementById("newServiceCostErr");
        const addBtn = document.querySelector(".add-service-btn");

        const name = (nameEl.value || "").trim();
        const costStr = (costEl.value || "").trim();
        const cost = parseFloat(costStr);

        const nameOk = /^[A-Za-z0-9\s.-]{2,}$/.test(name);
        const costOk = costStr !== "" && !isNaN(cost) && cost > 0;

        if (!nameOk && showMessages) {
          nameEl.classList.add("error-border");
          errName.textContent =
            "Enter at least 2 characters (letters, numbers, spaces, . or -)";
          errName.style.display = "block";
        } else {
          nameEl.classList.remove("error-border");
          errName.style.display = "none";
        }

        if (!costOk && showMessages) {
          costEl.classList.add("error-border");
          errCost.textContent = "Enter a valid cost greater than 0";
          errCost.style.display = "block";
        } else {
          costEl.classList.remove("error-border");
          errCost.style.display = "none";
        }

        if (addBtn) addBtn.disabled = !(nameOk && costOk);
        return nameOk && costOk;
      }

      function addService() {
        if (!validateNewServiceInputs(true)) return;
        const n = document.getElementById("newService").value.trim();
        const c = parseFloat(
          document.getElementById("newServiceCost").value.trim()
        );
        if (n && !isNaN(c)) {
          const li = document.createElement("li");
          li.className = "service-item";
          li.innerHTML = `<input type="text" class="service-name" value="${n}" required><input type="number" class="service-cost" value="${c}" required><button class="delete-btn" onclick="removeService(this)">Delete</button>`;
          document.getElementById("serviceList").appendChild(li);
          document.getElementById("newService").value = "";
          document.getElementById("newServiceCost").value = "";
          // Reset and disable Add again until valid
          const addBtn = document.querySelector(".add-service-btn");
          if (addBtn) addBtn.disabled = true;
        } else {
          alert("Please enter both a valid service name and cost.");
        }
      }
      function removeService(btn) {
        btn.parentElement.remove();
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadProfile();
        document
          .getElementById("delete-account-btn")
          .addEventListener("click", async () => {
            if (!currentUserId) return;
            if (
              confirm(
                "Are you sure you want to permanently delete your account? This action cannot be undone."
              )
            ) {
              try {
                const res = await fetch(
                  `/service/profile/delete/${currentUserId}`,
                  { method: "DELETE", headers: { Accept: "application/json" } }
                );
                const out = await res.json();
                if (!out.success)
                  throw new Error(out.message || "Delete failed");
                alert("Account deleted successfully.");
                window.location.href = "/";
              } catch (err) {
                console.error(err);
                alert(err.message);
              }
            }
          });
      });

      // Real-time validation on input change
      ["name", "phone", "district"].forEach((id) => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener("input", () => {
            validateForm();
          });
        }
      });
    </script>
  </body>
</html>
